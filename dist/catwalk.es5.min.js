"use strict";!function(e){var t="__catwalk",n={NEW:1,DIRTY:2,SAVED:4,DELETED:8},i=function(){this.events={},this.collections={},this.relationship=new s,this.typecast=new a,this.revertTypecast=!0};$traceurRuntime.createClass(i,{createCollection:function(e,t){var n=new r(e,t);return this.collections[e]=n,n},collection:function(e){return"undefined"==typeof this.collections[e]&&this.throwException('Unable to find collection "'+e+'"'),this.collections[e]},revertCallbackTypecast:function(e){this.revertTypecast=!!e},throwException:function(e){throw"Catwalk: "+e+"."},on:function(e,t){this.events[e]=t},off:function(e){delete this.events[e]}},{});var r=function(e,t){this.id=0,this.name=e,this.models=[],this.silent=!1,this.blueprint=new o(e,t)};$traceurRuntime.createClass(r,{silently:function(e){this.silent=!0,e.apply(this),this.silent=!1},createModel:function(){var e=void 0!==arguments[0]?arguments[0]:{};this.injectMeta(e);var t=this.blueprint.iterateAll(e);return Object.seal(t),this.models.push(t),this.issuePromise("create",t,null),t},readModel:function(e){return this.issuePromise("read",e,null),e},updateModel:function(e,t){var n=this,i={};Object.keys(e).forEach(function(t){return i[t]=e[t]});try{Object.keys(t).forEach(function(n){return e[n]=t[n]})}catch(r){}var o=this.blueprint.reiterateProperties(e);return Object.keys(o).forEach(function(t){n.blueprint.model[t]instanceof u||(e[t]=o[t])}),this.issuePromise("update",e,i),e},deleteModel:function(e){var n=this,i=function(e,t){n.issuePromise("delete",null,e),n.models.splice(t,1)},r=!1;return function(){var t=n.models.indexOf(e);-1!==t&&(r=!0,i(n.models[t],t))}(),function(){if(!r){var o=0;n.models.forEach(function(n){n[t].id===e[t].id&&i(n,o),o++})}}(),e},addAssociation:function(e,n,i){this.blueprint.model[n]instanceof l||catwalk.throwException("Using `addAssociation` requires a hasMany relationship");var r=e[t].relationshipValues[n]();r=r.concat(i);var o={};return o[n]=r,this.updateModel(e,o)},removeAssociation:function(e,n,i){this.blueprint.model[n]instanceof l||catwalk.throwException("Using `removeAssociation` requires a hasMany relationship");var r=e[t].relationshipValues[n]();i.forEach(function(e){var t=r.indexOf(e);r.splice(t,1)});var o={};return o[n]=r,this.updateModel(e,o)},injectMeta:function(e){e[t]={id:++this.id,status:n.NEW,originalValues:{},relationshipValues:{}}},issuePromise:function(e,t,n){var i=this;this.silent||"function"==typeof catwalk.events[e]&&new Promise(function(r,o){catwalk.events[e](i.name,i.cleanModel(t||n),{resolve:r,reject:o})}).then(function(r){i.resolvePromise(e,t,n)(r)},function(r){i.rejectPromise(e,t,n)(r)})},resolvePromise:function(e,i,r){var o=this;return i&&"create"===e&&(i[t].status=n.SAVED),null===i&&r&&"delete"===e&&(r[t].status=n.DELETED),function(n){o.silently(function(){if(n&&"read"!==e&&o.updateModel(i,n),n&&!n.hasOwnProperty(t)&&"read"===e){var r=o.createModel(n);o.updateModel(i,r)}}),o.conditionallyEmitEvent()}},rejectPromise:function(e,i,r){var o=this,a=function(a){a&&o.silently(function(){"update"===e&&a.hasOwnProperty(t)&&(o.deleteModel(r),r[t].status=n.DELETED),o.updateModel(i,a),i[t].status=n.SAVED}),o.conditionallyEmitEvent()};return null===r&&"create"===e?(this.silently(function(){o.deleteModel(i),i[t].status=n.DELETED}),a):(null===i&&"delete"===e&&this.silently(function(){var e=o.updateModel({},r);o.models.push(e)}),i&&r&&"update"===e&&this.silently(function(){o.updateModel(i,r)}),a)},conditionallyEmitEvent:function(){"function"==typeof catwalk.events.refresh&&catwalk.events.refresh()},cleanModel:function(e){var n=this,i={};return Object.keys(e).forEach(function(r){if(r!==t){if(n.blueprint.model[r]instanceof u){var o=e[t].relationshipValues[r];return void(o&&(i[r]=o()))}return"function"==typeof n.blueprint.model[r]&&e[t]&&e[t].originalValues[r]?void(i[r]=e[t].originalValues[r]):void(i[r]=e[r])}}),i}},{});var o=function(e,t){this.name=e,this.model=Object.freeze(t)};$traceurRuntime.createClass(o,{iterateAll:function(e){var t=this.iterateProperties(e);return this.iterateBlueprint(t)},iterateProperties:function(e){var n=this,i={};return Object.keys(e).forEach(function(r){var o=e[r],a=n.model[r];if(r===t||"undefined"!=typeof a){if(a instanceof u&&(a=n.relationshipHandler(a),Object.defineProperty(i,r,a.defineRelationship(n.name,r)),a.setValues(e[r]),e[t]&&(e[t].relationshipValues[r]=function(){return a.values})),"function"==typeof a){var s=o;o=a(o),catwalk.revertTypecast&&s!==o&&(e[t].originalValues[r]=s)}i[r]=o}}),i},iterateBlueprint:function(e){var t=this;return Object.keys(this.model).forEach(function(n){if("undefined"==typeof e[n]){e[n]=t.model[n];var i=t.model[n];if(i instanceof u)return i=t.relationshipHandler(i),Object.defineProperty(e,n,i.defineRelationship(t.name,n)),void i.setValues([]);"function"==typeof t.model[n]&&(e[n]=i())}}),e},reiterateProperties:function(e){var t=this;return Object.keys(e).forEach(function(n){var i=t.model[n];"function"==typeof i&&(e[n]=i(e[n]))}),e},relationshipHandler:function(e){var t=[e.target.key,e.target.collection];return e instanceof l?e=new(Function.prototype.bind.apply(l,$traceurRuntime.spread([null],t))):e instanceof f&&(e=new(Function.prototype.bind.apply(f,$traceurRuntime.spread([null],t)))),e}},{});var a=function(){};$traceurRuntime.createClass(a,{returnValue:function(e,t,n){return e("undefined"!=typeof t?t:n)},string:function(){var e=void 0!==arguments[0]?arguments[0]:"",t=this;return function(n){return t.returnValue(String,n,e)}},"boolean":function(){var e=void 0!==arguments[0]?arguments[0]:!0,t=this;return function(n){return t.returnValue(Boolean,n,e)}},number:function(){var e=void 0!==arguments[0]?arguments[0]:0,t=this;return function(n){return t.returnValue(Number,n,e)}},autoIncrement:function(){var e=void 0!==arguments[0]?arguments[0]:1;return function(){return Number(e++)}},custom:function(e){return e}},{});var s=function(){};$traceurRuntime.createClass(s,{hasOne:function(e,t){return new f(e,t)},hasMany:function(e,t){return new l(e,t)}},{});var u=function(e,t){this.target={collection:t,key:e}};$traceurRuntime.createClass(u,{setValues:function(e){this.values=this.value=e},defineRelationship:function(e,t,n){return this.source={collection:e,key:t},{get:n.get,set:n.set,enumerable:!0}}},{});var l=function(){$traceurRuntime.defaultSuperCall(this,c.prototype,arguments)},c=l;$traceurRuntime.createClass(l,{defineRelationship:function(e,t){return $traceurRuntime.superCall(this,c.prototype,"defineRelationship",[e,t,{get:this.getModels.bind(this),set:this.setModels.bind(this)}])},getModels:function(){var e=this,t=function(){return i.models.filter(function(t){return-1!==e.values.indexOf(t[e.target.key])})},n=function(e,t){return e.filter(function(e){return t.indexOf(e)<0})},i=catwalk.collection(this.target.collection),r=t();if(r.length!==this.values.length){var o=r.map(function(t){return t[e.target.key]}),a=n(this.values,o);a.forEach(function(t){var n={};n[e.target.key]=t,i.readModel(n)}),r=t()}return r},setModels:function(e){this.values=e}},{},u);var f=function(){$traceurRuntime.defaultSuperCall(this,d.prototype,arguments)},d=f;$traceurRuntime.createClass(f,{defineRelationship:function(e,t){return $traceurRuntime.superCall(this,d.prototype,"defineRelationship",[e,t,{get:this.getModel.bind(this),set:this.setModel.bind(this)}])},getModel:function(){var e=this,t=function(){return n.models.find(function(t){return e.value===t[e.target.key]})},n=catwalk.collection(this.target.collection),i=t();if(!i){var r={};r[this.target.key]=this.value,n.readModel(r),i=t()}return i},setModel:function(e){this.value=e}},{},u),e.catwalk=new i,e.catwalk.STATES=n}(window);