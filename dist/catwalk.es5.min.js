"use strict";!function(t){var e="__catwalk",n={NEW:1,DIRTY:2,SAVED:4,DELETED:8},i=function(){this.events={},this.collections={}};$traceurRuntime.createClass(i,{createCollection:function(t,e){var n=new s(t,e);return this.collections[t]=n,n},on:function(t,e){this.events[t]=e}},{});var s=function(t,e){this.id=0,this.name=t,this.models=[],this.silent=!1,this.blueprint=new o(e)};$traceurRuntime.createClass(s,{silently:function(t){this.silent=!0,t.apply(this),this.silent=!1},createModel:function(t){var e=this.blueprint.iterateAll(t);return this.injectMeta(e),Object.seal(e),this.models.push(e),this.issuePromise("create",e,null),e},updateModel:function(t,e){var n={};Object.keys(t).forEach(function(e){return n[e]=t[e]});try{Object.keys(e).forEach(function(n){return t[n]=e[n]})}catch(i){}return this.issuePromise("update",t,n),t},deleteModel:function(t){var n=this,i=function(t,e){n.issuePromise("delete",null,t),n.models.splice(e,1)};return function(){var e=n.models.indexOf(t);-1!==e&&i(n.models[e],e)}(),function(){var s=0;n.models.forEach(function(n){n[e].id===t[e].id&&i(n,s),s++})}(),t},injectMeta:function(t){t[e]={id:++this.id,status:n.NEW}},issuePromise:function(t,e,n){var i=this;this.silent||"function"==typeof catwalk.events[t]&&new Promise(function(s,o){catwalk.events[t](i.name,i.cleanModel(e||n),{resolve:s,reject:o})}).then(function(s){i.resolvePromise(t,e,n)(s)},function(s){i.rejectPromise(t,e,n)(s)})},resolvePromise:function(t,i,s){var o=this;return i&&"create"===t&&(i[e].status=n.SAVED),null===i&&s&&"delete"===t&&(s[e].status=n.DELETED),function(t){o.silently(function(){t&&o.updateModel(i,t)}),o.conditionallyEmitEvent()}},rejectPromise:function(t,i,s){var o=this,r=function(r){r&&o.silently(function(){"update"===t&&r.hasOwnProperty(e)&&(o.deleteModel(s),s[e].status=n.DELETED),o.updateModel(i,r),i[e].status=n.SAVED}),o.conditionallyEmitEvent()};return null===s&&"create"===t?(this.silently(function(){o.deleteModel(i),i[e].status=n.DELETED}),r):(null===i&&"delete"===t&&this.silently(function(){var t=o.updateModel({},s);o.models.push(t)}),i&&s&&"update"===t?(this.silently(function(){o.updateModel(i,s)}),r):r)},conditionallyEmitEvent:function(){"function"==typeof catwalk.events.refresh&&catwalk.events.refresh()},cleanModel:function(t){var n={};return Object.keys(t).forEach(function(i){i!==e&&(n[i]=t[i])}),n}},{});var o=function(t){this.model=Object.freeze(t)};$traceurRuntime.createClass(o,{iterateAll:function(t){var e=this.iterateProperties(t);return this.iterateBlueprint(e)},iterateProperties:function(t){var e=this,n={};return Object.keys(t).forEach(function(i){var s=t[i],o=e.model[i];"undefined"!=typeof o&&("function"==typeof o&&(s=o(s)),n[i]=s)}),n},iterateBlueprint:function(t){var e=this;return Object.keys(this.model).forEach(function(n){if("function"==typeof t[n])try{throw void 0}catch(i){return i=e.model[n],void(t[n]=i())}"undefined"==typeof t[n]&&(t[n]=null)}),t}},{}),t.catwalk=new i}(window);