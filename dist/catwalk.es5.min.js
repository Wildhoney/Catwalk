"use strict";!function(t){var e="__catwalk",n={NEW:1,DIRTY:2,SAVED:4,DELETED:8},i=function(){this.events={},this.collections={},this.relationship=new u,this.typecast=new o};$traceurRuntime.createClass(i,{createCollection:function(t,e){var n=new r(t,e);return this.collections[t]=n,n},collection:function(t){return"undefined"==typeof this.collections[t]&&this.throwException('Unable to find collection "'+t+'"'),this.collections[t]},throwException:function(t){throw"Catwalk: "+t+"."},on:function(t,e){this.events[t]=e},off:function(t){delete this.events[t]}},{});var r=function(t,e){this.id=0,this.name=t,this.models=[],this.silent=!1,this.blueprint=new s(t,e)};$traceurRuntime.createClass(r,{silently:function(t){this.silent=!0,t.apply(this),this.silent=!1},createModel:function(){var t=void 0!==arguments[0]?arguments[0]:{},e=this.blueprint.iterateAll(t);return this.injectMeta(e),Object.seal(e),this.models.push(e),this.issuePromise("create",e,null),e},readModel:function(t){return this.issuePromise("read",t,null),t},updateModel:function(t,e){var n={};Object.keys(t).forEach(function(e){return n[e]=t[e]});try{Object.keys(e).forEach(function(n){return t[n]=e[n]})}catch(i){}return this.issuePromise("update",t,n),t},deleteModel:function(t){var n=this,i=function(t,e){n.issuePromise("delete",null,t),n.models.splice(e,1)};return function(){var e=n.models.indexOf(t);-1!==e&&i(n.models[e],e)}(),function(){var r=0;n.models.forEach(function(n){n[e].id===t[e].id&&i(n,r),r++})}(),t},injectMeta:function(t){t[e]={id:++this.id,status:n.NEW}},issuePromise:function(t,e,n){var i=this;this.silent||"function"==typeof catwalk.events[t]&&new Promise(function(r,s){catwalk.events[t](i.name,i.cleanModel(e||n),{resolve:r,reject:s})}).then(function(r){i.resolvePromise(t,e,n)(r)},function(r){i.rejectPromise(t,e,n)(r)})},resolvePromise:function(t,i,r){var s=this;return i&&"create"===t&&(i[e].status=n.SAVED),null===i&&r&&"delete"===t&&(r[e].status=n.DELETED),function(e){s.silently(function(){if(e&&"read"!==t&&s.updateModel(i,e),"read"===t){var n=s.createModel(e);s.updateModel(i,n)}}),s.conditionallyEmitEvent()}},rejectPromise:function(t,i,r){var s=this,o=function(o){o&&s.silently(function(){"update"===t&&o.hasOwnProperty(e)&&(s.deleteModel(r),r[e].status=n.DELETED),s.updateModel(i,o),i[e].status=n.SAVED}),s.conditionallyEmitEvent()};return null===r&&"create"===t?(this.silently(function(){s.deleteModel(i),i[e].status=n.DELETED}),o):(null===i&&"delete"===t&&this.silently(function(){var t=s.updateModel({},r);s.models.push(t)}),i&&r&&"update"===t?(this.silently(function(){s.updateModel(i,r)}),o):o)},conditionallyEmitEvent:function(){"function"==typeof catwalk.events.refresh&&catwalk.events.refresh()},cleanModel:function(t){var n={};return Object.keys(t).forEach(function(i){i!==e&&(n[i]=t[i])}),n}},{});var s=function(t,e){this.name=t,this.model=Object.freeze(e)};$traceurRuntime.createClass(s,{iterateAll:function(t){var e=this.iterateProperties(t);return this.iterateBlueprint(e)},iterateProperties:function(t){var e=this,n={};return Object.keys(t).forEach(function(i){var r=t[i],s=e.model[i];"undefined"!=typeof s&&(s instanceof a&&(Object.defineProperty(n,i,s.defineRelationship(e.name,i)),s.setValues(t[i])),"function"==typeof s&&(r=s(r)),n[i]=r)}),n},iterateBlueprint:function(t){var e=this;return Object.keys(this.model).forEach(function(n){if("undefined"==typeof t[n]&&(t[n]=e.model[n],"function"==typeof e.model[n]))try{throw void 0}catch(i){i=e.model[n],t[n]=i()}}),t}},{});var o=function(){};$traceurRuntime.createClass(o,{string:function(){var t=void 0!==arguments[0]?arguments[0]:"";return function(e){return String(e||t)}},number:function(){var t=void 0!==arguments[0]?arguments[0]:0;return function(e){return Number(e||t)}}},{});var u=function(){};$traceurRuntime.createClass(u,{hasOne:function(t,e){return new f(t,e)},hasMany:function(t,e){return new l(t,e)}},{});var a=function(t,e){this.target={collection:e,key:t}};$traceurRuntime.createClass(a,{setValues:function(t){this.values=this.value=t},defineRelationship:function(t,e,n){return this.source={collection:t,key:e},{get:n.get,set:n.set}}},{});var l=function(){$traceurRuntime.defaultSuperCall(this,c.prototype,arguments)},c=l;$traceurRuntime.createClass(l,{defineRelationship:function(t,e){return $traceurRuntime.superCall(this,c.prototype,"defineRelationship",[t,e,{get:this.getModels.bind(this),set:this.setModels.bind(this)}])},getModels:function(){var t=this,e=function(){return i.models.filter(function(e){return-1!==t.values.indexOf(e[t.target.key])})},n=function(t,e){return t.filter(function(t){return e.indexOf(t)<0})},i=catwalk.collection(this.target.collection),r=e();if(r.length!==this.values.length){var s=r.map(function(e){return e[t.target.key]}),o=n(this.values,s);o.forEach(function(e){var n={};n[t.target.key]=e,i.readModel(n)}),r=e()}return r},setModels:function(t){this.values=t}},{},a);var f=function(){$traceurRuntime.defaultSuperCall(this,d.prototype,arguments)},d=f;$traceurRuntime.createClass(f,{defineRelationship:function(t,e){return $traceurRuntime.superCall(this,d.prototype,"defineRelationship",[t,e,{get:this.getModel.bind(this),set:this.setModel.bind(this)}])},getModel:function(){var t=this,e=function(){return n.models.find(function(e){return t.value===e[t.target.key]})},n=catwalk.collection(this.target.collection),i=e();if(!i){var r={};r[this.target.key]=this.value,n.readModel(r),i=e()}return i},setModel:function(t){this.value=t}},{},a),t.catwalk=new i}(window);