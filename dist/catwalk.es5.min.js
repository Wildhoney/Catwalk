"use strict";!function(t){var e="__catwalk",n={NEW:1,DIRTY:2,SAVED:4,DELETED:8},i=function(){this.events={},this.collections={}};$traceurRuntime.createClass(i,{createCollection:function(t,e){var n=new o(t,e);return this.collections[t]=n,n},on:function(t,e){this.events[t]=e}},{});var o=function(t,e){this.id=0,this.name=t,this.models=[],this.silent=!1,this.blueprint=new s(e)};$traceurRuntime.createClass(o,{silently:function(t){this.silent=!0,t.apply(this),this.silent=!1},createModel:function(t){var e=this.blueprint.iterateAll(t);return this.injectMeta(e),Object.seal(e),this.models.push(e),this.issuePromise("create",e,null),e},updateModel:function(t,e){var n={};Object.keys(t).forEach(function(e){return n[e]=t[e]});try{Object.keys(e).forEach(function(n){return t[n]=e[n]})}catch(i){}return this.issuePromise("update",t,n),t},deleteModel:function(t){var i=this,o=function(t,o){t[e].status=n.DELETED,i.issuePromise("delete",null,t),i.models.splice(o,1)};!function(){var e=i.models.indexOf(t);-1!==e&&o(i.models[e],e)}(),function(){var n=0;i.models.forEach(function(i){i[e].id===t[e].id&&o(i,n),n++})}()},injectMeta:function(t){t[e]={id:++this.id,status:n.NEW}},issuePromise:function(t,e,n){var i=this;this.silent||"function"==typeof catwalk.events[t]&&new Promise(function(n,o){catwalk.events[t](i.name,i.cleanModel(e),{resolve:n,reject:o})}).then(function(o){i.resolvePromise(t,e,n)(o)},function(o){i.rejectPromise(t,e,n)(o)})},resolvePromise:function(t,i){var o=this;return i[e].status=n.SAVED,function(t){o.silently(function(){t&&o.updateModel(i,t)}),o.conditionallyEmitEvent()}},rejectPromise:function(t,i,o){var s=this,r=function(r){r&&s.silently(function(){"update"===t&&r.hasOwnProperty(e)&&s.deleteModel(o),s.updateModel(i,r),i[e].status=n.SAVED}),s.conditionallyEmitEvent()};return null===o?(this.silently(function(){s.deleteModel(i)}),r):i&&o?(this.silently(function(){s.updateModel(i,o)}),r):r},conditionallyEmitEvent:function(){"function"==typeof catwalk.events.refresh&&catwalk.events.refresh()},cleanModel:function(t){var n={};return Object.keys(t).forEach(function(i){i!==e&&(n[i]=t[i])}),n}},{});var s=function(t){this.model=Object.freeze(t)};$traceurRuntime.createClass(s,{iterateAll:function(t){var e=this.iterateProperties(t);return this.iterateBlueprint(e)},iterateProperties:function(t){var e=this,n={};return Object.keys(t).forEach(function(i){var o=t[i],s=e.model[i];"undefined"!=typeof s&&("function"==typeof s&&(o=s(o)),n[i]=o)}),n},iterateBlueprint:function(t){var e=this;return Object.keys(this.model).forEach(function(n){if("function"==typeof t[n])try{throw void 0}catch(i){return i=e.model[n],void(t[n]=i())}"undefined"==typeof t[n]&&(t[n]=null)}),t}},{}),t.catwalk=new i}(window);