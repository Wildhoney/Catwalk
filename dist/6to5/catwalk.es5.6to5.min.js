"use strict";var _applyConstructor=function(e,t){var n=Object.create(e.prototype),r=e.apply(n,t);return null==r||"object"!=typeof r&&"function"!=typeof r?n:r},_toArray=function(e){return Array.isArray(e)?e:Array.from(e)},_get=function e(t,n,r){var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,n,r)}if("value"in i&&i.writable)return i.value;var o=i.get;return void 0===o?void 0:o.call(r)},_inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)},_prototypeProperties=function(e,t,n){t&&Object.defineProperties(e,t),n&&Object.defineProperties(e.prototype,n)};!function(e,t){var n="__catwalk",r={NEW:1,DIRTY:2,SAVED:4,DELETED:8},i=function(){function e(){this.events={},this.collections={},this.relationship=new u,this.typecast=new l,this.revertTypecast=!0}return _prototypeProperties(e,null,{createCollection:{value:function(e){var t=void 0===arguments[1]?{}:arguments[1];e=String(e),0===e.length&&this.throwException("Collection must have an associated name"),0===Object.keys(t).length&&this.throwException('Collection "'+e+'" must define its blueprint');var n=new a(e,t);return this.collections[e]=n,n},writable:!0,enumerable:!0,configurable:!0},deleteCollection:{value:function(e){this.collections[e]&&delete this.collections[e]},writable:!0,enumerable:!0,configurable:!0},collection:{value:function(e){return"undefined"==typeof this.collections[e]&&this.throwException('Unable to find collection "'+e+'"'),this.collections[e]},writable:!0,enumerable:!0,configurable:!0},createTransaction:{value:function(){return new b},writable:!0,enumerable:!0,configurable:!0},revertCallbackTypecast:{value:function(e){this.revertTypecast=!!e},writable:!0,enumerable:!0,configurable:!0},throwException:{value:function(e){throw"Catwalk: "+e+"."},writable:!0,enumerable:!0,configurable:!0},on:{value:function(e){var t=this,n=void 0===arguments[1]?function(){}:arguments[1];(e||"").split(/\s+/g).forEach(function(e){t.events[e]=n})},writable:!0,enumerable:!0,configurable:!0},off:{value:function(e){var t=this;(e||"").split(/\s+/g).forEach(function(e){delete t.events[e]})},writable:!0,enumerable:!0,configurable:!0}}),e}(),a=function(){function i(e,t){this.id=0,this.name=e,this.models=[],this.silent=!1,this.blueprint=new o(e,t)}return _prototypeProperties(i,null,{silently:{value:function(e){var t=this.silent;this.silent=!0,e.apply(this),t||(this.silent=!1)},writable:!0,enumerable:!0,configurable:!0},extensibleIteration:{value:function(){var e=[],t=function(e){var t={};return Object.keys(e).forEach(function(n){return t[n]=e[n]}),t};return this.models.forEach(function(n){return e.push(t(n))}),e},writable:!0,enumerable:!0,configurable:!0},addModel:{value:function(){var e=this,t=void 0===arguments[0]?{}:arguments[0],n={};return this.silently(function(){n=e.createModel(t)}),this.silent||this.conditionallyEmitEvent(),n},writable:!0,enumerable:!0,configurable:!0},addModels:{value:function(){var e=void 0===arguments[0]?[]:arguments[0];Array.isArray(e)||catwalk.throwException("Argument for `addModels` must be an array of properties");var t=[];return this.silently(function(){var n=this;e.forEach(function(e){t.push(n.addModel(e))})}),this.conditionallyEmitEvent(),t},writable:!0,enumerable:!0,configurable:!0},createModel:{value:function(){var e=void 0===arguments[0]?{}:arguments[0];this.injectMeta(e);var t=this.blueprint.iterateAll(e);return Object.seal(t),this.models.push(t),this.issuePromise("create",t,null),t},writable:!0,enumerable:!0,configurable:!0},readModel:{value:function(e){return this.issuePromise("read",e,null),e},writable:!0,enumerable:!0,configurable:!0},updateModel:{value:function(e,t){var n=this,r={};Object.keys(e).forEach(function(t){return r[t]=e[t]});try{Object.keys(t).forEach(function(n){return e[n]=t[n]})}catch(i){}var a=this.blueprint.reiterateProperties(e);return Object.keys(a).forEach(function(t){n.blueprint.model[t]instanceof s||(e[t]=a[t])}),this.issuePromise("update",e,r),e},writable:!0,enumerable:!0,configurable:!0},getModelById:{value:function(e){return this.models.find(function(t){return t[n].id===e})},writable:!0,enumerable:!0,configurable:!0},deleteModel:{value:function(e){var t=this,r=function(e,n){t.issuePromise("delete",null,e),t.models.splice(n,1)},i=!1;return function(){var n=t.models.indexOf(e);-1!==n&&(i=!0,r(t.models[n],n))}(),i||!function(){var i=0;t.models.forEach(function(t){t[n].id===e[n].id&&r(t,i),i++})}(),e},writable:!0,enumerable:!0,configurable:!0},addAssociation:{value:function(e,t,r){this.blueprint.model[t]instanceof c||catwalk.throwException("Using `addAssociation` requires a hasMany relationship");var i=e[n].relationshipValues[t]();i=i.concat(r);var a={};return a[t]=i,this.updateModel(e,a)},writable:!0,enumerable:!0,configurable:!0},removeAssociation:{value:function(e,t,r){this.blueprint.model[t]instanceof c||catwalk.throwException("Using `removeAssociation` requires a hasMany relationship");var i=e[n].relationshipValues[t]();r.forEach(function(e){var t=i.indexOf(e);i.splice(t,1)});var a={};return a[t]=i,this.updateModel(e,a)},writable:!0,enumerable:!0,configurable:!0},injectMeta:{value:function(e){e[n]={id:++this.id,status:r.NEW,originalValues:{},relationshipValues:{}}},writable:!0,enumerable:!0,configurable:!0},issuePromise:{value:function(e,t,n){var r=this;this.silent||"function"==typeof catwalk.events[e]&&new Promise(function(i,a){catwalk.events[e].call(r,r.cleanModel(t||n),{resolve:i,reject:a})}).then(function(i){r.resolvePromise(e,t,n)(i)},function(i){r.rejectPromise(e,t,n)(i)})},writable:!0,enumerable:!0,configurable:!0},resolvePromise:{value:function(e,t,i){var a=this;return t&&"create"===e&&(t[n].status=r.SAVED),null===t&&i&&"delete"===e&&(i[n].status=r.DELETED),function(r){a.silently(function(){if(r&&"read"!==e&&a.updateModel(t,r),r&&!r.hasOwnProperty(n)&&"read"===e){var i=a.createModel(r);a.updateModel(t,i)}}),a.conditionallyEmitEvent()}},writable:!0,enumerable:!0,configurable:!0},rejectPromise:{value:function(e,t,i){var a=this,o=function(o){o&&a.silently(function(){"update"===e&&o.hasOwnProperty(n)&&(a.deleteModel(i),i[n].status=r.DELETED),a.updateModel(t,o),t[n].status=r.SAVED}),a.conditionallyEmitEvent()};return null===i&&"create"===e?(this.silently(function(){a.deleteModel(t),t[n].status=r.DELETED}),o):(null===t&&"delete"===e&&this.silently(function(){var e=a.updateModel({},i);a.models.push(e)}),t&&i&&"update"===e&&this.silently(function(){a.updateModel(t,i)}),o)},writable:!0,enumerable:!0,configurable:!0},conditionallyEmitEvent:{value:function(){"function"==typeof catwalk.events.refresh&&(catwalk.events.refresh(),this.awakenFramework().angular())},writable:!0,enumerable:!0,configurable:!0},awakenFramework:{value:function(){return{angular:function(){if("undefined"!=typeof e.angular){var n=e.angular.element(t.querySelector("*[ng-app]"));if("scope"in n){var r=n.scope();r.$$phase||r.$apply()}}}}},writable:!0,enumerable:!0,configurable:!0},cleanModel:{value:function(e){var t=this,r={};return Object.keys(e).forEach(function(i){if(i!==n){if(t.blueprint.model[i]instanceof s){var a=e[n].relationshipValues[i];return void(a&&(r[i]=a()))}return"function"==typeof t.blueprint.model[i]&&e[n]&&e[n].originalValues[i]?void(r[i]=e[n].originalValues[i]):void(r[i]=e[i])}}),r},writable:!0,enumerable:!0,configurable:!0}}),i}(),o=function(){function e(e,t){this.name=e,this.model=Object.freeze(t)}return _prototypeProperties(e,null,{iterateAll:{value:function(e){var t=this.iterateProperties(e);return this.iterateBlueprint(t)},writable:!0,enumerable:!0,configurable:!0},iterateProperties:{value:function(e){var t=this,r={};return Object.keys(e).forEach(function(i){var a=e[i],o=t.model[i];if(i===n||"undefined"!=typeof o){if(o instanceof s&&(o=t.relationshipHandler(o),Object.defineProperty(r,i,o.defineRelationship(t.name,i)),o.setValues(e[i]),e[n]&&(e[n].relationshipValues[i]=function(){return o.values})),"function"==typeof o){var l=a;a=o(a),catwalk.revertTypecast&&l!==a&&(e[n].originalValues[i]=l)}r[i]=a}}),r},writable:!0,enumerable:!0,configurable:!0},iterateBlueprint:{value:function(e){var t=this;return Object.keys(this.model).forEach(function(n){if("undefined"==typeof e[n]){e[n]=t.model[n];var r=t.model[n];if(r instanceof s)return r=t.relationshipHandler(r),Object.defineProperty(e,n,r.defineRelationship(t.name,n)),void r.setValues([]);"function"==typeof t.model[n]&&(e[n]=r())}}),e},writable:!0,enumerable:!0,configurable:!0},reiterateProperties:{value:function(e){var t=this;return Object.keys(e).forEach(function(n){var r=t.model[n];"function"==typeof r&&(e[n]=r(e[n]))}),e},writable:!0,enumerable:!0,configurable:!0},relationshipHandler:{value:function(e){var t=[e.target.key,e.target.collection];return e instanceof c?_applyConstructor(c,_toArray(t)):e instanceof f?_applyConstructor(f,_toArray(t)):void catwalk.throwException("Invalid relationship type")},writable:!0,enumerable:!0,configurable:!0}}),e}(),l=function(){function e(){}return _prototypeProperties(e,null,{returnValue:{value:function(e,t,n){return e("undefined"!=typeof t?t:n)},writable:!0,enumerable:!0,configurable:!0},string:{value:function(){var e=this,t=void 0===arguments[0]?"":arguments[0];return function(n){return e.returnValue(String,n,t)}},writable:!0,enumerable:!0,configurable:!0},"boolean":{value:function(){var e=this,t=void 0===arguments[0]?!0:arguments[0];return function(n){return e.returnValue(Boolean,n,t)}},writable:!0,enumerable:!0,configurable:!0},number:{value:function(){var e=this,t=void 0===arguments[0]?0:arguments[0];return function(n){return e.returnValue(Number,n,t)}},writable:!0,enumerable:!0,configurable:!0},array:{value:function(){var e=this,t=void 0===arguments[0]?[]:arguments[0];return function(n){return e.returnValue(Array,n,t)}},writable:!0,enumerable:!0,configurable:!0},autoIncrement:{value:function(){var e=void 0===arguments[0]?1:arguments[0];return function(){return Number(e++)}},writable:!0,enumerable:!0,configurable:!0},custom:{value:function(e){return e},writable:!0,enumerable:!0,configurable:!0}}),e}(),u=function(){function e(){}return _prototypeProperties(e,null,{hasOne:{value:function(e,t){return new f(e,t)},writable:!0,enumerable:!0,configurable:!0},hasMany:{value:function(e,t){return new c(e,t)},writable:!0,enumerable:!0,configurable:!0}}),e}(),s=function(){function e(e,t){this.target={collection:t,key:e}}return _prototypeProperties(e,null,{setValues:{value:function(e){this.values=this.value=e},writable:!0,enumerable:!0,configurable:!0},defineRelationship:{value:function(e,t,n){return this.source={collection:e,key:t},{get:n.get,set:n.set,enumerable:!0}},writable:!0,enumerable:!0,configurable:!0},assertForeignPropertyExists:{value:function(e,t){"undefined"==typeof e.blueprint.model[t]&&catwalk.throwException('Unable to find property "'+t+'" in collection "'+e.name+'"')},writable:!0,enumerable:!0,configurable:!0}}),e}(),c=function(e){function t(){null!==Object.getPrototypeOf(t)&&Object.getPrototypeOf(t).apply(this,arguments)}return _inherits(t,e),_prototypeProperties(t,null,{defineRelationship:{value:function(e,n){return _get(Object.getPrototypeOf(t.prototype),"defineRelationship",this).call(this,e,n,{get:this.getModels.bind(this),set:this.setModels.bind(this)})},writable:!0,enumerable:!0,configurable:!0},getModels:{value:function(){var e=this,t=function(){return r.models.filter(function(t){return-1!==e.values.indexOf(t[e.target.key])})},n=function(e,t){return e.filter(function(e){return t.indexOf(e)<0})},r=catwalk.collection(this.target.collection),i=t();if(this.assertForeignPropertyExists(r,this.target.key),i.length!==this.values.length){var a=i.map(function(t){return t[e.target.key]}),o=n(this.values,a);o.forEach(function(t){var n={};n[e.target.key]=t,r.readModel(n)}),i=t()}return i},writable:!0,enumerable:!0,configurable:!0},setModels:{value:function(e){this.values=e},writable:!0,enumerable:!0,configurable:!0}}),t}(s),f=function(e){function t(){null!==Object.getPrototypeOf(t)&&Object.getPrototypeOf(t).apply(this,arguments)}return _inherits(t,e),_prototypeProperties(t,null,{defineRelationship:{value:function(e,n){return _get(Object.getPrototypeOf(t.prototype),"defineRelationship",this).call(this,e,n,{get:this.getModel.bind(this),set:this.setModel.bind(this)})},writable:!0,enumerable:!0,configurable:!0},getModel:{value:function(){var e=this,t=function(){return n.models.find(function(t){return e.value===t[e.target.key]})},n=catwalk.collection(this.target.collection),r=t();if(this.assertForeignPropertyExists(n,this.target.key),!r){var i={};i[this.target.key]=this.value,n.readModel(i),r=t()}return r},writable:!0,enumerable:!0,configurable:!0},setModel:{value:function(e){this.value=e},writable:!0,enumerable:!0,configurable:!0}}),t}(s),b=function(){function e(){var e=this;this.models=[],this.resolveFn=function(){},setTimeout(function(){return e.flush})}return _prototypeProperties(e,null,{add:{value:function(e,t){this.models.push({model:e,promise:t})},writable:!0,enumerable:!0,configurable:!0},resolve:{value:function(e){this.resolveFn=e},writable:!0,enumerable:!0,configurable:!0},flush:{value:function(){this.resolveFn(this.models)},writable:!0,enumerable:!0,configurable:!0}}),e}();e.catwalk=new i,e.catwalk.META=n,e.catwalk.STATES=r}(window,window.document);