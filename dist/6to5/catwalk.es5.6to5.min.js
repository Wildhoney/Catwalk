"use strict";var _applyConstructor=function(t,e){var n=Object.create(t.prototype),o=t.apply(n,e);return null==o||"object"!=typeof o&&"function"!=typeof o?n:o},_toArray=function(t){return Array.isArray(t)?t:Array.from(t)},_get=function t(e,n,o){var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,o)}if("value"in r&&r.writable)return r.value;var s=r.get;return void 0===s?void 0:s.call(o)},_inherits=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(t.__proto__=e)};!function(t){var e="__catwalk",n={NEW:1,DIRTY:2,SAVED:4,DELETED:8},o=function(){this.events={},this.collections={},this.relationship=new a,this.typecast=new s,this.revertTypecast=!0};o.prototype.createCollection=function(t){var e=void 0===arguments[1]?{}:arguments[1];t=String(t),0===t.length&&this.throwException("Collection must have an associated name"),0===Object.keys(e).length&&this.throwException('Collection "'+t+'" must define its blueprint');var n=new r(t,e);return this.collections[t]=n,n},o.prototype.deleteCollection=function(t){this.collections[t]&&delete this.collections[t]},o.prototype.collection=function(t){return"undefined"==typeof this.collections[t]&&this.throwException('Unable to find collection "'+t+'"'),this.collections[t]},o.prototype.createTransaction=function(){return new p},o.prototype.revertCallbackTypecast=function(t){this.revertTypecast=!!t},o.prototype.throwException=function(t){throw"Catwalk: "+t+"."},o.prototype.on=function(t){var e=this,n=void 0===arguments[1]?function(){}:arguments[1];(t||"").split(/\s+/g).forEach(function(t){e.events[t]=n})},o.prototype.off=function(t){var e=this;(t||"").split(/\s+/g).forEach(function(t){delete e.events[t]})};var r=function(t,e){this.id=0,this.name=t,this.models=[],this.silent=!1,this.blueprint=new i(t,e)};r.prototype.silently=function(t){var e=this.silent;this.silent=!0,t.apply(this),e||(this.silent=!1)},r.prototype.extensibleIteration=function(){var t=[],e=function(t){var e={};return Object.keys(t).forEach(function(n){return e[n]=t[n]}),e};return this.models.forEach(function(n){return t.push(e(n))}),t},r.prototype.addModel=function(){var t=this,e=void 0===arguments[0]?{}:arguments[0],n={};return this.silently(function(){n=t.createModel(e)}),this.silent||this.conditionallyEmitEvent(),n},r.prototype.addModels=function(){var t=void 0===arguments[0]?[]:arguments[0];Array.isArray(t)||catwalk.throwException("Argument for `addModels` must be an array of properties");var e=[];return this.silently(function(){var n=this;t.forEach(function(t){e.push(n.addModel(t))})}),this.conditionallyEmitEvent(),e},r.prototype.createModel=function(){var t=void 0===arguments[0]?{}:arguments[0];this.injectMeta(t);var e=this.blueprint.iterateAll(t);return Object.seal(e),this.models.push(e),this.issuePromise("create",e,null),e},r.prototype.readModel=function(t){return this.issuePromise("read",t,null),t},r.prototype.updateModel=function(t,e){var n=this,o={};Object.keys(t).forEach(function(e){return o[e]=t[e]});try{Object.keys(e).forEach(function(n){return t[n]=e[n]})}catch(r){}var i=this.blueprint.reiterateProperties(t);return Object.keys(i).forEach(function(e){n.blueprint.model[e]instanceof u||(t[e]=i[e])}),this.issuePromise("update",t,o),t},r.prototype.getModelById=function(t){return this.models.find(function(n){return n[e].id===t})},r.prototype.deleteModel=function(t){var n=this,o=function(t,e){n.issuePromise("delete",null,t),n.models.splice(e,1)},r=!1;return function(){var e=n.models.indexOf(t);-1!==e&&(r=!0,o(n.models[e],e))}(),r||!function(){var r=0;n.models.forEach(function(n){n[e].id===t[e].id&&o(n,r),r++})}(),t},r.prototype.addAssociation=function(t,n,o){this.blueprint.model[n]instanceof l||catwalk.throwException("Using `addAssociation` requires a hasMany relationship");var r=t[e].relationshipValues[n]();r=r.concat(o);var i={};return i[n]=r,this.updateModel(t,i)},r.prototype.removeAssociation=function(t,n,o){this.blueprint.model[n]instanceof l||catwalk.throwException("Using `removeAssociation` requires a hasMany relationship");var r=t[e].relationshipValues[n]();o.forEach(function(t){var e=r.indexOf(t);r.splice(e,1)});var i={};return i[n]=r,this.updateModel(t,i)},r.prototype.injectMeta=function(t){t[e]={id:++this.id,status:n.NEW,originalValues:{},relationshipValues:{}}},r.prototype.issuePromise=function(t,e,n){var o=this;this.silent||"function"==typeof catwalk.events[t]&&new Promise(function(r,i){catwalk.events[t].call(o,o.cleanModel(e||n),{resolve:r,reject:i})}).then(function(r){o.resolvePromise(t,e,n)(r)},function(r){o.rejectPromise(t,e,n)(r)})},r.prototype.resolvePromise=function(t,o,r){var i=this;return o&&"create"===t&&(o[e].status=n.SAVED),null===o&&r&&"delete"===t&&(r[e].status=n.DELETED),function(n){i.silently(function(){if(n&&"read"!==t&&i.updateModel(o,n),n&&!n.hasOwnProperty(e)&&"read"===t){var r=i.createModel(n);i.updateModel(o,r)}}),i.conditionallyEmitEvent()}},r.prototype.rejectPromise=function(t,o,r){var i=this,s=function(s){s&&i.silently(function(){"update"===t&&s.hasOwnProperty(e)&&(i.deleteModel(r),r[e].status=n.DELETED),i.updateModel(o,s),o[e].status=n.SAVED}),i.conditionallyEmitEvent()};return null===r&&"create"===t?(this.silently(function(){i.deleteModel(o),o[e].status=n.DELETED}),s):(null===o&&"delete"===t&&this.silently(function(){var t=i.updateModel({},r);i.models.push(t)}),o&&r&&"update"===t&&this.silently(function(){i.updateModel(o,r)}),s)},r.prototype.conditionallyEmitEvent=function(){"function"==typeof catwalk.events.refresh&&catwalk.events.refresh()},r.prototype.cleanModel=function(t){var n=this,o={};return Object.keys(t).forEach(function(r){if(r!==e){if(n.blueprint.model[r]instanceof u){var i=t[e].relationshipValues[r];return void(i&&(o[r]=i()))}return"function"==typeof n.blueprint.model[r]&&t[e]&&t[e].originalValues[r]?void(o[r]=t[e].originalValues[r]):void(o[r]=t[r])}}),o};var i=function(t,e){this.name=t,this.model=Object.freeze(e)};i.prototype.iterateAll=function(t){var e=this.iterateProperties(t);return this.iterateBlueprint(e)},i.prototype.iterateProperties=function(t){var n=this,o={};return Object.keys(t).forEach(function(r){var i=t[r],s=n.model[r];if(r===e||"undefined"!=typeof s){if(s instanceof u&&(s=n.relationshipHandler(s),Object.defineProperty(o,r,s.defineRelationship(n.name,r)),s.setValues(t[r]),t[e]&&(t[e].relationshipValues[r]=function(){return s.values})),"function"==typeof s){var a=i;i=s(i),catwalk.revertTypecast&&a!==i&&(t[e].originalValues[r]=a)}o[r]=i}}),o},i.prototype.iterateBlueprint=function(t){var e=this;return Object.keys(this.model).forEach(function(n){if("undefined"==typeof t[n]){t[n]=e.model[n];var o=e.model[n];if(o instanceof u)return o=e.relationshipHandler(o),Object.defineProperty(t,n,o.defineRelationship(e.name,n)),void o.setValues([]);"function"==typeof e.model[n]&&(t[n]=o())}}),t},i.prototype.reiterateProperties=function(t){var e=this;return Object.keys(t).forEach(function(n){var o=e.model[n];"function"==typeof o&&(t[n]=o(t[n]))}),t},i.prototype.relationshipHandler=function(t){var e=[t.target.key,t.target.collection];return t instanceof l?_applyConstructor(l,_toArray(e)):t instanceof c?_applyConstructor(c,_toArray(e)):void catwalk.throwException("Invalid relationship type")};var s=function(){};s.prototype.returnValue=function(t,e,n){return t("undefined"!=typeof e?e:n)},s.prototype.string=function(){var t=this,e=void 0===arguments[0]?"":arguments[0];return function(n){return t.returnValue(String,n,e)}},s.prototype.boolean=function(){var t=this,e=void 0===arguments[0]?!0:arguments[0];return function(n){return t.returnValue(Boolean,n,e)}},s.prototype.number=function(){var t=this,e=void 0===arguments[0]?0:arguments[0];return function(n){return t.returnValue(Number,n,e)}},s.prototype.array=function(){var t=this,e=void 0===arguments[0]?[]:arguments[0];return function(n){return t.returnValue(Array,n,e)}},s.prototype.autoIncrement=function(){var t=void 0===arguments[0]?1:arguments[0];return function(){return Number(t++)}},s.prototype.custom=function(t){return t};var a=function(){};a.prototype.hasOne=function(t,e){return new c(t,e)},a.prototype.hasMany=function(t,e){return new l(t,e)};var u=function(t,e){this.target={collection:e,key:t}};u.prototype.setValues=function(t){this.values=this.value=t},u.prototype.defineRelationship=function(t,e,n){return this.source={collection:t,key:e},{get:n.get,set:n.set,enumerable:!0}},u.prototype.assertForeignPropertyExists=function(t,e){"undefined"==typeof t.blueprint.model[e]&&catwalk.throwException('Unable to find property "'+e+'" in collection "'+t.name+'"')};var l=function(){var t=u,e=function n(){null!==Object.getPrototypeOf(n)&&Object.getPrototypeOf(n).apply(this,arguments)};return _inherits(e,t),e.prototype.defineRelationship=function(t,n){return _get(Object.getPrototypeOf(e.prototype),"defineRelationship",this).call(this,t,n,{get:this.getModels.bind(this),set:this.setModels.bind(this)})},e.prototype.getModels=function(){var t=this,e=function(){return o.models.filter(function(e){return-1!==t.values.indexOf(e[t.target.key])})},n=function(t,e){return t.filter(function(t){return e.indexOf(t)<0})},o=catwalk.collection(this.target.collection),r=e();if(this.assertForeignPropertyExists(o,this.target.key),r.length!==this.values.length){var i=r.map(function(e){return e[t.target.key]}),s=n(this.values,i);s.forEach(function(e){var n={};n[t.target.key]=e,o.readModel(n)}),r=e()}return r},e.prototype.setModels=function(t){this.values=t},e}(),c=function(){var t=u,e=function n(){null!==Object.getPrototypeOf(n)&&Object.getPrototypeOf(n).apply(this,arguments)};return _inherits(e,t),e.prototype.defineRelationship=function(t,n){return _get(Object.getPrototypeOf(e.prototype),"defineRelationship",this).call(this,t,n,{get:this.getModel.bind(this),set:this.setModel.bind(this)})},e.prototype.getModel=function(){var t=this,e=function(){return n.models.find(function(e){return t.value===e[t.target.key]})},n=catwalk.collection(this.target.collection),o=e();if(this.assertForeignPropertyExists(n,this.target.key),!o){var r={};r[this.target.key]=this.value,n.readModel(r),o=e()}return o},e.prototype.setModel=function(t){this.value=t},e}(),p=function(){var t=this;this.models=[],this.resolveFn=function(){},setTimeout(function(){return t.flush})};p.prototype.add=function(t,e){this.models.push({model:t,promise:e})},p.prototype.resolve=function(t){this.resolveFn=t},p.prototype.flush=function(){this.resolveFn(this.models)},t.catwalk=new o,t.catwalk.META=e,t.catwalk.STATES=n}(window);