"use strict";
(function($window) {
  "use strict";
  var CATWALK_META_PROPERTY = '__catwalk';
  var CATWALK_STATES_PROPERTIES = {
    NEW: 1,
    DIRTY: 2,
    SAVED: 4,
    DELETED: 8
  };
  var Catwalk = function Catwalk() {
    this.events = {};
    this.collections = {};
    this.relationship = new Relationship();
  };
  ($traceurRuntime.createClass)(Catwalk, {
    createCollection: function(name, properties) {
      var collection = new Collection(name, properties);
      this.collections[name] = collection;
      return collection;
    },
    on: function(name, eventFn) {
      this.events[name] = eventFn;
    }
  }, {});
  var Collection = function Collection(name, properties) {
    this.id = 0;
    this.name = name;
    this.models = [];
    this.silent = false;
    this.blueprint = new BlueprintModel(properties);
  };
  ($traceurRuntime.createClass)(Collection, {
    silently: function(silentFn) {
      this.silent = true;
      silentFn.apply(this);
      this.silent = false;
    },
    createModel: function(properties) {
      var model = this.blueprint.iterateAll(properties);
      this.injectMeta(model);
      Object.seal(model);
      this.models.push(model);
      this.issuePromise('create', model, null);
      return model;
    },
    updateModel: function(model, properties) {
      var previousModel = {};
      Object.keys(model).forEach((function(property) {
        return previousModel[property] = model[property];
      }));
      try {
        Object.keys(properties).forEach((function(property) {
          return model[property] = properties[property];
        }));
      } catch (e) {}
      this.issuePromise('update', model, previousModel);
      return model;
    },
    deleteModel: function(model) {
      var $__0 = this;
      var remove = (function(model, index) {
        $__0.issuePromise('delete', null, model);
        $__0.models.splice(index, 1);
      });
      ((function() {
        var index = $__0.models.indexOf(model);
        if (index !== -1) {
          remove($__0.models[index], index);
        }
      }))();
      ((function() {
        var index = 0;
        $__0.models.forEach((function(currentModel) {
          if (currentModel[CATWALK_META_PROPERTY].id === model[CATWALK_META_PROPERTY].id) {
            remove(currentModel, index);
          }
          index++;
        }));
      }))();
      return model;
    },
    injectMeta: function(model) {
      model[CATWALK_META_PROPERTY] = {
        id: ++this.id,
        status: CATWALK_STATES_PROPERTIES.NEW
      };
    },
    issuePromise: function(eventName, currentModel, previousModel) {
      var $__0 = this;
      if (this.silent) {
        return;
      }
      if (typeof catwalk.events[eventName] !== 'function') {
        return;
      }
      new Promise((function(resolve, reject) {
        catwalk.events[eventName]($__0.name, $__0.cleanModel(currentModel || previousModel), {
          resolve: resolve,
          reject: reject
        });
      })).then((function(resolutionParams) {
        $__0.resolvePromise(eventName, currentModel, previousModel)(resolutionParams);
      }), (function(resolutionParams) {
        $__0.rejectPromise(eventName, currentModel, previousModel)(resolutionParams);
      }));
    },
    resolvePromise: function(eventName, currentModel, previousModel) {
      var $__0 = this;
      void(previousModel);
      if (currentModel && eventName === 'create') {
        currentModel[CATWALK_META_PROPERTY].status = CATWALK_STATES_PROPERTIES.SAVED;
      }
      if ((currentModel === null && previousModel) && eventName === 'delete') {
        previousModel[CATWALK_META_PROPERTY].status = CATWALK_STATES_PROPERTIES.DELETED;
      }
      return (function(properties) {
        $__0.silently((function() {
          if (properties) {
            $__0.updateModel(currentModel, properties);
          }
        }));
        $__0.conditionallyEmitEvent();
      });
    },
    rejectPromise: function(eventName, currentModel, previousModel) {
      var $__0 = this;
      var rejectWith = (function(duplicateModel) {
        if (duplicateModel) {
          $__0.silently((function() {
            if (eventName === 'update' && duplicateModel.hasOwnProperty(CATWALK_META_PROPERTY)) {
              $__0.deleteModel(previousModel);
              previousModel[CATWALK_META_PROPERTY].status = CATWALK_STATES_PROPERTIES.DELETED;
            }
            $__0.updateModel(currentModel, duplicateModel);
            currentModel[CATWALK_META_PROPERTY].status = CATWALK_STATES_PROPERTIES.SAVED;
          }));
        }
        $__0.conditionallyEmitEvent();
      });
      if (previousModel === null && eventName === 'create') {
        this.silently((function() {
          $__0.deleteModel(currentModel);
          currentModel[CATWALK_META_PROPERTY].status = CATWALK_STATES_PROPERTIES.DELETED;
        }));
        return rejectWith;
      }
      if (currentModel === null && eventName === 'delete') {
        this.silently((function() {
          var model = $__0.updateModel({}, previousModel);
          $__0.models.push(model);
        }));
      }
      if ((currentModel && previousModel) && eventName === 'update') {
        this.silently((function() {
          $__0.updateModel(currentModel, previousModel);
        }));
        return rejectWith;
      }
      return rejectWith;
    },
    conditionallyEmitEvent: function() {
      if (typeof catwalk.events.refresh === 'function') {
        catwalk.events.refresh();
      }
    },
    cleanModel: function(model) {
      var cleanedModel = {};
      Object.keys(model).forEach((function(property) {
        if (property === CATWALK_META_PROPERTY) {
          return;
        }
        cleanedModel[property] = model[property];
      }));
      return cleanedModel;
    }
  }, {});
  var BlueprintModel = function BlueprintModel(blueprint) {
    this.model = Object.freeze(blueprint);
  };
  ($traceurRuntime.createClass)(BlueprintModel, {
    iterateAll: function(properties) {
      var model = this.iterateProperties(properties);
      return this.iterateBlueprint(model);
    },
    iterateProperties: function(properties) {
      var $__0 = this;
      var model = {};
      Object.keys(properties).forEach((function(property) {
        var value = properties[property],
            propertyHandler = $__0.model[property];
        if (typeof propertyHandler === 'undefined') {
          return;
        }
        if (typeof propertyHandler === 'function') {
          value = propertyHandler(value);
        }
        model[property] = value;
      }));
      return model;
    },
    iterateBlueprint: function(model) {
      var $__0 = this;
      Object.keys(this.model).forEach((function(property) {
        if (typeof model[property] === 'function') {
          try {
            throw undefined;
          } catch (propertyHandler) {
            {
              propertyHandler = $__0.model[property];
              model[property] = propertyHandler();
              return;
            }
          }
        }
        if (typeof model[property] === 'undefined') {
          model[property] = null;
        }
      }));
      return model;
    }
  }, {});
  var Relationship = function Relationship() {};
  ($traceurRuntime.createClass)(Relationship, {
    hasOne: function(foreignKey, collectionName) {
      return new RelationshipHasOne(foreignKey, collectionName);
    },
    hasMany: function(foreignKey, collectionName) {
      return new RelationshipHasMany(foreignKey, collectionName);
    }
  }, {});
  var RelationshipAbstract = function RelationshipAbstract(foreignKey, collectionName) {
    this.foreignKey = foreignKey;
    this.collectionName = collectionName;
  };
  ($traceurRuntime.createClass)(RelationshipAbstract, {}, {});
  var RelationshipHasMany = function RelationshipHasMany() {
    $traceurRuntime.defaultSuperCall(this, $RelationshipHasMany.prototype, arguments);
  };
  var $RelationshipHasMany = RelationshipHasMany;
  ($traceurRuntime.createClass)(RelationshipHasMany, {}, {}, RelationshipAbstract);
  var RelationshipHasOne = function RelationshipHasOne() {
    $traceurRuntime.defaultSuperCall(this, $RelationshipHasOne.prototype, arguments);
  };
  var $RelationshipHasOne = RelationshipHasOne;
  ($traceurRuntime.createClass)(RelationshipHasOne, {}, {}, RelationshipAbstract);
  $window.catwalk = new Catwalk();
})(window);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkNhdHdhbGsuanMiLCJAdHJhY2V1ci9nZW5lcmF0ZWQvVGVtcGxhdGVQYXJzZXIvMSIsIkB0cmFjZXVyL2dlbmVyYXRlZC9UZW1wbGF0ZVBhcnNlci8yIiwiQHRyYWNldXIvZ2VuZXJhdGVkL1RlbXBsYXRlUGFyc2VyLzMiLCJAdHJhY2V1ci9nZW5lcmF0ZWQvVGVtcGxhdGVQYXJzZXIvNSIsIkB0cmFjZXVyL2dlbmVyYXRlZC9UZW1wbGF0ZVBhcnNlci80Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUEsQUFBQyxTQUFTLE9BQU07QUFFWixhQUFXLENBQUM7SUFNTixDQUFBLHFCQUFvQixFQUFJLFlBQVU7SUFNbEMsQ0FBQSx5QkFBd0IsRUFBSTtBQUFFLE1BQUUsQ0FBRyxFQUFBO0FBQUcsUUFBSSxDQUFHLEVBQUE7QUFBRyxRQUFJLENBQUcsRUFBQTtBQUFHLFVBQU0sQ0FBRyxFQUFBO0FBQUEsRUFBRTtBQ2QvRSxBQUFJLElBQUEsVURtQkEsU0FBTSxRQUFNLENBTUcsQUFBQyxDQUFFO0FBQ1YsT0FBRyxPQUFPLEVBQVUsR0FBQyxDQUFDO0FBQ3RCLE9BQUcsWUFBWSxFQUFLLEdBQUMsQ0FBQztBQUN0QixPQUFHLGFBQWEsRUFBSSxJQUFJLGFBQVcsQUFBQyxFQUFDLENBQUM7RUM1QlYsQUQ2QmhDLENDN0JnQztBQ0F4QyxFQUFDLGVBQWMsWUFBWSxDQUFDLEFBQUM7QUZtQ3JCLG1CQUFlLENBQWYsVUFBaUIsSUFBRyxDQUFHLENBQUEsVUFBUyxDQUFHO0FBRS9CLEFBQUksUUFBQSxDQUFBLFVBQVMsRUFBSSxJQUFJLFdBQVMsQUFBQyxDQUFDLElBQUcsQ0FBRyxXQUFTLENBQUMsQ0FBQztBQUNqRCxTQUFHLFlBQVksQ0FBRSxJQUFHLENBQUMsRUFBSSxXQUFTLENBQUM7QUFDbkMsV0FBTyxXQUFTLENBQUM7SUFFckI7QUFRQSxLQUFDLENBQUQsVUFBRyxJQUFHLENBQUcsQ0FBQSxPQUFNLENBQUc7QUFDZCxTQUFHLE9BQU8sQ0FBRSxJ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S3pqQkE7QUw4akJwRCxRQUFNLFFBQVEsRUFBSSxJQUFJLFFBQU0sQUFBQyxFQUFDLENBQUM7QUFFbkMsQ0FBQyxBQUFDLENBQUMsTUFBSyxDQUFDLENBQUM7QUFBQSIsImZpbGUiOiJjYXR3YWxrLmVzNS5qcyIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbigkd2luZG93KSB7XG5cbiAgICBcInVzZSBzdHJpY3RcIjtcblxuICAgIC8qKlxuICAgICAqIEBjb25zdGFudCBDQVRXQUxLX01FVEFfUFJPUEVSVFlcbiAgICAgKiBAdHlwZSB7U3RyaW5nfVxuICAgICAqL1xuICAgIGNvbnN0IENBVFdBTEtfTUVUQV9QUk9QRVJUWSA9ICdfX2NhdHdhbGsnO1xuXG4gICAgLyoqXG4gICAgICogQGNvbnN0YW50IENBVFdBTEtfU1RBVEVfUFJPUEVSVElFU1xuICAgICAqIEB0eXBlIHtPYmplY3R9XG4gICAgICovXG4gICAgY29uc3QgQ0FUV0FMS19TVEFURVNfUFJPUEVSVElFUyA9IHsgTkVXOiAxLCBESVJUWTogMiwgU0FWRUQ6IDQsIERFTEVURUQ6IDggfTtcblxuICAgIC8qKlxuICAgICAqIEBjbGFzcyBDYXR3YWxrXG4gICAgICovXG4gICAgY2xhc3MgQ2F0d2FsayB7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBjb25zdHJ1Y3RvclxuICAgICAgICAgKiBAcmV0dXJuIHtDYXR3YWxrfVxuICAgICAgICAgKi9cbiAgICAgICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgICAgICB0aGlzLmV2ZW50cyAgICAgICA9IHt9O1xuICAgICAgICAgICAgdGhpcy5jb2xsZWN0aW9ucyAgPSB7fTtcbiAgICAgICAgICAgIHRoaXMucmVsYXRpb25zaGlwID0gbmV3IFJlbGF0aW9uc2hpcCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBtZXRob2QgY3JlYXRlQ29sbGVjdGlvblxuICAgICAgICAgKiBAcmV0dXJuIHtDYXR3YWxrLkNvbGxlY3Rpb259XG4gICAgICAgICAqL1xuICAgICAgICBjcmVhdGVDb2xsZWN0aW9uKG5hbWUsIHByb3BlcnRpZXMpIHtcblxuICAgICAgICAgICAgdmFyIGNvbGxlY3Rpb24gPSBuZXcgQ29sbGVjdGlvbihuYW1lLCBwcm9wZXJ0aWVzKTtcbiAgICAgICAgICAgIHRoaXMuY29sbGVjdGlvbnNbbmFtZV0gPSBjb2xsZWN0aW9uO1xuICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3Rpb247XG5cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAbWV0aG9kIG9uXG4gICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9XG4gICAgICAgICAqIEBwYXJhbSBldmVudEZuIHtGdW5jdGlvbn1cbiAgICAgICAgICogQHJldHVybiB7dm9pZH1cbiAgICAgICAgICovXG4gICAgICAgIG9uKG5hbWUsIGV2ZW50Rm4pIHtcbiAgICAgICAgICAgIHRoaXMuZXZlbnRzW25hbWVdID0gZXZlbnRGbjtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGNsYXNzIENvbGxlY3Rpb25cbiAgICAgKi9cbiAgICBjbGFzcyBDb2xsZWN0aW9uIHtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQGNvbnN0cnVjdG9yXG4gICAgICAgICAqIEBwYXJhbSBuYW1lIHtTdHJpbmd9XG4gICAgICAgICAqIEBwYXJhbSBwcm9wZXJ0aWVzIHtPYmplY3R9XG4gICAgICAgICAqIEByZXR1cm4ge0NvbGxlY3Rpb259XG4gICAgICAgICAqL1xuICAgICAgICBjb25zdHJ1Y3RvcihuYW1lLCBwcm9wZXJ0aWVzKSB7XG4gICAgICAgICAgICB0aGlzLmlkICAgICAgICA9IDA7XG4gICAgICAgICAgICB0aGlzLm5hbWUgICAgICA9IG5hbWU7XG4gICAgICAgICAgICB0aGlzLm1vZGVscyAgICA9IFtdO1xuICAgICAgICAgICAgdGhpcy5zaWxlbnQgICAgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMuYmx1ZXByaW50ID0gbmV3IEJsdWVwcmludE1vZGVsKHByb3BlcnRpZXMpO1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBtZXRob2Qgc2lsZW50bHlcbiAgICAgICAgICogQHBhcmFtIHNpbGVudEZuIHtGdW5jdGlvbn1cbiAgICAgICAgICogQHJldHVybiB7dm9pZH1cbiAgICAgICAgICovXG4gICAgICAgIHNpbGVudGx5KHNpbGVudEZuKSB7XG4gICAgICAgICAgICB0aGlzLnNpbGVudCA9IHRydWU7XG4gICAgICAgICAgICBzaWxlbnRGbi5hcHBseSh0aGlzKTtcbiAgICAgICAgICAgIHRoaXMuc2lsZW50ID0gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQG1ldGhvZCBjcmVhdGVNb2RlbFxuICAgICAgICAgKiBAcGFyYW0gcHJvcGVydGllcyB7T2JqZWN0fVxuICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICBjcmVhdGVNb2RlbChwcm9wZXJ0aWVzKSB7XG5cbiAgICAgICAgICAgIC8vIEVuc3VyZSB0aGUgbW9kZWwgY29uZm9ybXMgdG8gdGhlIGJsdWVwcmludC5cbiAgICAgICAgICAgIHZhciBtb2RlbCA9IHRoaXMuYmx1ZXByaW50Lml0ZXJhdGVBbGwocHJvcGVydGllcyk7XG5cbiAgICAgICAgICAgIHRoaXMuaW5qZWN0TWV0YShtb2RlbCk7XG4gICAgICAgICAgICBPYmplY3Quc2VhbChtb2RlbCk7XG4gICAgICAgICAgICB0aGlzLm1vZGVscy5wdXNoKG1vZGVsKTtcbiAgICAgICAgICAgIHRoaXMuaXNzdWVQcm9taXNlKCdjcmVhdGUnLCBtb2RlbCwgbnVsbCk7XG4gICAgICAgICAgICByZXR1cm4gbW9kZWw7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAbWV0aG9kIHVwZGF0ZU1vZGVsXG4gICAgICAgICAqIEBwYXJhbSBtb2RlbCB7T2JqZWN0fVxuICAgICAgICAgKiBAcGFyYW0gcHJvcGVydGllcyB7T2JqZWN0fVxuICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICB1cGRhdGVNb2RlbChtb2RlbCwgcHJvcGVydGllcykge1xuXG4gICAgICAgICAgICAvLyBDcmVhdGUgYSBjb3B5IG9mIHRoZSBvbGQgbW9kZWwgZm9yIHJvbGxpbmcgYmFjay5cbiAgICAgICAgICAgIHZhciBwcmV2aW91c01vZGVsID0ge307XG4gICAgICAgICAgICBPYmplY3Qua2V5cyhtb2RlbCkuZm9yRWFjaChwcm9wZXJ0eSA9PiBwcmV2aW91c01vZGVsW3Byb3BlcnR5XSA9IG1vZGVsW3Byb3BlcnR5XSk7XG5cbiAgICAgICAgICAgIHRyeSB7XG5cbiAgICAgICAgICAgICAgICAvLyBDb3B5IGFjcm9zcyB0aGUgZGF0YSBmcm9tIHRoZSBwcm9wZXJ0aWVzLiBXZSB3cmFwIHRoZSBhc3NpZ25tZW50IGluIGEgdHJ5LWNhdGNoIGJsb2NrXG4gICAgICAgICAgICAgICAgLy8gYmVjYXVzZSBpZiB0aGUgdXNlciBoYXMgYWRkZWQgYW55IGFkZGl0aW9uYWwgcHJvcGVydGllcyB0aGF0IGRvbid0IGJlbG9uZyBpbiB0aGUgbW9kZWwsXG4gICAgICAgICAgICAgICAgLy8gYW4gZXhjZXB0aW9uIHdpbGwgYmUgcmFpc2VkIGJlY2F1c2UgdGhlIG9iamVjdCBpcyBzZWFsZWQuXG4gICAgICAgICAgICAgICAgT2JqZWN0LmtleXMocHJvcGVydGllcykuZm9yRWFjaChwcm9wZXJ0eSA9PiBtb2RlbFtwcm9wZXJ0eV0gPSBwcm9wZXJ0aWVzW3Byb3BlcnR5XSk7XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlKSB7fVxuXG4gICAgICAgICAgICB0aGlzLmlzc3VlUHJvbWlzZSgndXBkYXRlJywgbW9kZWwsIHByZXZpb3VzTW9kZWwpO1xuICAgICAgICAgICAgcmV0dXJuIG1vZGVsO1xuXG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQG1ldGhvZCBkZWxldGVNb2RlbFxuICAgICAgICAgKiBAcGFyYW0gbW9kZWwge09iamVjdH1cbiAgICAgICAgICogQHJldHVybiB7dm9pZH1cbiAgICAgICAgICovXG4gICAgICAgIGRlbGV0ZU1vZGVsKG1vZGVsKSB7XG5cbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogQG1ldGhvZCByZW1vdmVcbiAgICAgICAgICAgICAqIEBwYXJhbSBtb2RlbCB7T2JqZWN0fVxuICAgICAgICAgICAgICogQHBhcmFtIGluZGV4IHtOdW1iZXJ9XG4gICAgICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9XG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIHZhciByZW1vdmUgPSAobW9kZWwsIGluZGV4KSA9PiB7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmlzc3VlUHJvbWlzZSgnZGVsZXRlJywgbnVsbCwgbW9kZWwpO1xuICAgICAgICAgICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7XG5cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICgoKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAvLyBUcnkgdG8gZmluZCB0aGUgbW9kZWwgYnkgcmVmZXJlbmNlLlxuICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMubW9kZWxzLmluZGV4T2YobW9kZWwpO1xuXG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICByZW1vdmUodGhpcy5tb2RlbHNbaW5kZXhdLCBpbmRleCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KSgpO1xuXG4gICAgICAgICAgICAoKCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gMDtcblxuICAgICAgICAgICAgICAgIC8vIFRyeSB0byBmaW5kIHRoZSBtb2RlbCBieSBpdHMgaW50ZXJuYWwgQ2F0d2FsayBJRC5cbiAgICAgICAgICAgICAgICB0aGlzLm1vZGVscy5mb3JFYWNoKChjdXJyZW50TW9kZWwpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE1vZGVsW0NBVFdBTEtfTUVUQV9QUk9QRVJUWV0uaWQgPT09IG1vZGVsW0NBVFdBTEtfTUVUQV9QUk9QRVJUWV0uaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZShjdXJyZW50TW9kZWwsIGluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGluZGV4Kys7XG5cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgfSkoKTtcblxuICAgICAgICAgICAgcmV0dXJuIG1vZGVsO1xuXG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQG1ldGhvZCBpbmplY3RNZXRhXG4gICAgICAgICAqIEBwYXJhbSBtb2RlbCB7T2JqZWN0fVxuICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICBpbmplY3RNZXRhKG1vZGVsKSB7XG5cbiAgICAgICAgICAgIG1vZGVsW0NBVFdBTEtfTUVUQV9QUk9QRVJUWV0gPSB7XG4gICAgICAgICAgICAgICAgaWQ6ICsrdGhpcy5pZCxcbiAgICAgICAgICAgICAgICBzdGF0dXM6IENBVFdBTEtfU1RBVEVTX1BST1BFUlRJRVMuTkVXXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAbWV0aG9kIGlzc3VlUHJvbWlzZVxuICAgICAgICAgKiBAcGFyYW0gZXZlbnROYW1lIHtTdHJpbmd9XG4gICAgICAgICAqIEBwYXJhbSBjdXJyZW50TW9kZWwge09iamVjdH1cbiAgICAgICAgICogQHBhcmFtIHByZXZpb3VzTW9kZWwge09iamVjdH1cbiAgICAgICAgICogQHJldHVybiB7dm9pZH1cbiAgICAgICAgICovXG4gICAgICAgIGlzc3VlUHJvbWlzZShldmVudE5hbWUsIGN1cnJlbnRNb2RlbCwgcHJldmlvdXNNb2RlbCkge1xuXG4gICAgICAgICAgICBpZiAodGhpcy5zaWxlbnQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0eXBlb2YgY2F0d2Fsay5ldmVudHNbZXZlbnROYW1lXSAhPT0gJ2Z1bmN0aW9uJykge1xuXG4gICAgICAgICAgICAgICAgLy8gQ2FsbGJhY2sgaGFzIG5vdCBhY3R1YWxseSBiZWVuIHNldC11cCBhbmQgdGhlcmVmb3JlIG1vZGVscyB3aWxsIG5ldmVyIGJlXG4gICAgICAgICAgICAgICAgLy8gcGVyc2lzdGVkLlxuICAgICAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cbiAgICAgICAgICAgICAgICAvLyBJc3N1ZSB0aGUgcHJvbWlzZSBmb3IgYmFjay1lbmQgcGVyc2lzdGVuY2Ugb2YgdGhlIG1vZGVsLlxuICAgICAgICAgICAgICAgIGNhdHdhbGsuZXZlbnRzW2V2ZW50TmFtZV0odGhpcy5uYW1lLCB0aGlzLmNsZWFuTW9kZWwoY3VycmVudE1vZGVsIHx8IHByZXZpb3VzTW9kZWwpLCB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmU6IHJlc29sdmUsIHJlamVjdDogcmVqZWN0XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIH0pLnRoZW4oKHJlc29sdXRpb25QYXJhbXMpID0+IHtcblxuICAgICAgICAgICAgICAgIC8vIFByb21pc2UgaGFzIGJlZW4gcmVzb2x2ZWQhXG4gICAgICAgICAgICAgICAgdGhpcy5yZXNvbHZlUHJvbWlzZShldmVudE5hbWUsIGN1cnJlbnRNb2RlbCwgcHJldmlvdXNNb2RlbCkocmVzb2x1dGlvblBhcmFtcyk7XG5cbiAgICAgICAgICAgIH0sIChyZXNvbHV0aW9uUGFyYW1zKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAvLyBQcm9taXNlIGhhcyBiZWVuIHJlamVjdGVkIVxuICAgICAgICAgICAgICAgIHRoaXMucmVqZWN0UHJvbWlzZShldmVudE5hbWUsIGN1cnJlbnRNb2RlbCwgcHJldmlvdXNNb2RlbCkocmVzb2x1dGlvblBhcmFtcyk7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQG1ldGhvZCByZXNvbHZlUHJvbWlzZVxuICAgICAgICAgKiBAcGFyYW0gZXZlbnROYW1lIHtTdHJpbmd9XG4gICAgICAgICAqIEBwYXJhbSBjdXJyZW50TW9kZWwge09iamVjdH1cbiAgICAgICAgICogQHBhcmFtIHByZXZpb3VzTW9kZWwge09iamVjdH1cbiAgICAgICAgICogQHJldHVybiB7RnVuY3Rpb259XG4gICAgICAgICAqL1xuICAgICAgICByZXNvbHZlUHJvbWlzZShldmVudE5hbWUsIGN1cnJlbnRNb2RlbCwgcHJldmlvdXNNb2RlbCkge1xuXG4gICAgICAgICAgICAvLyBDdXJyZW50bHkgdW51c2VkIHByb3BlcnRpZXMuXG4gICAgICAgICAgICB2b2lkKHByZXZpb3VzTW9kZWwpO1xuXG4gICAgICAgICAgICAvLyBXaGVuIHdlJ3JlIGluIHRoZSBwcm9jZXNzIG9mIGRlbGV0aW5nIGEgbW9kZWwsIHRoZSBgY3VycmVudE1vZGVsYCBpcyB1bnNldDsgaW5zdGVhZCB0aGVcbiAgICAgICAgICAgIC8vIGBwcmV2aW91c01vZGVsYCB3aWxsIGJlIGRlZmluZWQuXG4gICAgICAgICAgICBpZiAoY3VycmVudE1vZGVsICYmIGV2ZW50TmFtZSA9PT0gJ2NyZWF0ZScpIHtcblxuICAgICAgICAgICAgICAgIC8vIE1vZGVsIGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSBwZXJzaXN0ZWQhXG4gICAgICAgICAgICAgICAgY3VycmVudE1vZGVsW0NBVFdBTEtfTUVUQV9QUk9QRVJUWV0uc3RhdHVzID0gQ0FUV0FMS19TVEFURVNfUFJPUEVSVElFUy5TQVZFRDtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoKGN1cnJlbnRNb2RlbCA9PT0gbnVsbCAmJiBwcmV2aW91c01vZGVsKSAmJiBldmVudE5hbWUgPT09ICdkZWxldGUnKSB7XG5cbiAgICAgICAgICAgICAgICAvLyBNb2RlbCBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgZGVsZXRlZCFcbiAgICAgICAgICAgICAgICBwcmV2aW91c01vZGVsW0NBVFdBTEtfTUVUQV9QUk9QRVJUWV0uc3RhdHVzID0gQ0FUV0FMS19TVEFURVNfUFJPUEVSVElFUy5ERUxFVEVEO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiAocHJvcGVydGllcykgPT4ge1xuXG4gICAgICAgICAgICAgICAgdGhpcy5zaWxlbnRseSgoKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTW9kZWwoY3VycmVudE1vZGVsLCBwcm9wZXJ0aWVzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmNvbmRpdGlvbmFsbHlFbWl0RXZlbnQoKTtcblxuICAgICAgICAgICAgfTtcblxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBtZXRob2QgcmVqZWN0UHJvbWlzZVxuICAgICAgICAgKiBAcGFyYW0gZXZlbnROYW1lIHtTdHJpbmd9IC0gRXZlbnQgbmFtZSBpcyBhY3R1YWxseSBub3QgcmVxdWlyZWQsIGJlY2F1c2Ugd2UgY2FuIGRlZHVjZSB0aGUgc3Vic2VxdWVudCBhY3Rpb25cbiAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb20gdGhlIHN0YXRlIG9mIHRoZSBgY3VycmVudE1vZGVsYCBhbmQgYHByZXZpb3VzTW9kZWxgLCBidXQgd2UgYWRkIGl0IHRvIGFkZFxuICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhcmlmaWNhdGlvbiB0byBvdXIgbG9naWNhbCBzdGVwcy5cbiAgICAgICAgICogQHBhcmFtIGN1cnJlbnRNb2RlbCB7T2JqZWN0fVxuICAgICAgICAgKiBAcGFyYW0gcHJldmlvdXNNb2RlbCB7T2JqZWN0fVxuICAgICAgICAgKiBAcmV0dXJuIHtGdW5jdGlvbn1cbiAgICAgICAgICovXG4gICAgICAgIHJlamVjdFByb21pc2UoZXZlbnROYW1lLCBjdXJyZW50TW9kZWwsIHByZXZpb3VzTW9kZWwpIHtcblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBAbWV0aG9kIHJlamVjdFdpdGhcbiAgICAgICAgICAgICAqIEBwYXJhbSBkdXBsaWNhdGVNb2RlbCB7T2JqZWN0fVxuICAgICAgICAgICAgICogQHJldHVybiB7dm9pZH1cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgdmFyIHJlamVjdFdpdGggPSAoZHVwbGljYXRlTW9kZWwpID0+IHtcblxuICAgICAgICAgICAgICAgIGlmIChkdXBsaWNhdGVNb2RlbCkge1xuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2lsZW50bHkoKCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnROYW1lID09PSAndXBkYXRlJyAmJiBkdXBsaWNhdGVNb2RlbC5oYXNPd25Qcm9wZXJ0eShDQVRXQUxLX01FVEFfUFJPUEVSVFkpKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBVc2VyIHBhc3NlZCBpbiBhIG1vZGVsIGFuZCB0aGVyZWZvcmUgdGhlIHByZXZpb3VzIHNob3VsZCBiZSBkZWxldGVkLCBidXQgb25seVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdoZW4gd2UncmUgdXBkYXRpbmchXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWxldGVNb2RlbChwcmV2aW91c01vZGVsKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c01vZGVsW0NBVFdBTEtfTUVUQV9QUk9QRVJUWV0uc3RhdHVzID0gQ0FUV0FMS19TVEFURVNfUFJPUEVSVElFUy5ERUxFVEVEO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFVzZSB0aGUgZHVwbGljYXRlIG1vZGVsIGFzIHRoZSByZWZlcmVuY2UuXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZU1vZGVsKGN1cnJlbnRNb2RlbCwgZHVwbGljYXRlTW9kZWwpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE1vZGVsW0NBVFdBTEtfTUVUQV9QUk9QRVJUWV0uc3RhdHVzID0gQ0FUV0FMS19TVEFURVNfUFJPUEVSVElFUy5TQVZFRDtcblxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHRoaXMuY29uZGl0aW9uYWxseUVtaXRFdmVudCgpO1xuXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAocHJldmlvdXNNb2RlbCA9PT0gbnVsbCAmJiBldmVudE5hbWUgPT09ICdjcmVhdGUnKSB7XG5cbiAgICAgICAgICAgICAgICB0aGlzLnNpbGVudGx5KCgpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICAvLyBQcmV2aW91cyBtb2RlbCB3YXMgYWN0dWFsbHkgTlVMTCBhbmQgdGhlcmVmb3JlIHdlJ2xsIGRlbGV0ZSBpdC5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWxldGVNb2RlbChjdXJyZW50TW9kZWwpO1xuICAgICAgICAgICAgICAgICAgICBjdXJyZW50TW9kZWxbQ0FUV0FMS19NRVRBX1BST1BFUlRZXS5zdGF0dXMgPSBDQVRXQUxLX1NUQVRFU19QUk9QRVJUSUVTLkRFTEVURUQ7XG5cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHJldHVybiByZWplY3RXaXRoO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjdXJyZW50TW9kZWwgPT09IG51bGwgJiYgZXZlbnROYW1lID09PSAnZGVsZXRlJyApIHtcblxuICAgICAgICAgICAgICAgIHRoaXMuc2lsZW50bHkoKCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIERldmVsb3BlciBkb2Vzbid0IGFjdHVhbGx5IHdhbnQgdG8gZGVsZXRlIHRoZSBtb2RlbCwgYW5kIHRoZXJlZm9yZSB3ZSBuZWVkIHRvIHJldmVydCBpdCB0b1xuICAgICAgICAgICAgICAgICAgICAvLyB0aGUgbW9kZWwgaXQgd2FzLCBhbmQgc2V0IGl0cyBmbGFnIGJhY2sgdG8gd2hhdCBpdCB3YXMuXG4gICAgICAgICAgICAgICAgICAgIHZhciBtb2RlbCA9IHRoaXMudXBkYXRlTW9kZWwoe30sIHByZXZpb3VzTW9kZWwpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVscy5wdXNoKG1vZGVsKTtcblxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICgoY3VycmVudE1vZGVsICYmIHByZXZpb3VzTW9kZWwpICYmIGV2ZW50TmFtZSA9PT0gJ3VwZGF0ZScpIHtcblxuICAgICAgICAgICAgICAgIHRoaXMuc2lsZW50bHkoKCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIEJvdGggb2YgdGhlIGN1cnJlbnQgYW5kIHByZXZpb3VzIG1vZGVscyBhcmUgdXBkYXRlZCwgYW5kIHRoZXJlZm9yZSB3ZSdsbCBzaW1wbHlcbiAgICAgICAgICAgICAgICAgICAgLy8gcmV2ZXJ0IHRoZSBjdXJyZW50IG1vZGVsIHRvIHRoZSBwcmV2aW91cyBtb2RlbC5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVNb2RlbChjdXJyZW50TW9kZWwsIHByZXZpb3VzTW9kZWwpO1xuXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0V2l0aDtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0V2l0aDtcblxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBtZXRob2QgY29uZGl0aW9uYWxseUVtaXRFdmVudFxuICAgICAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAgICAgKi9cbiAgICAgICAgY29uZGl0aW9uYWxseUVtaXRFdmVudCgpIHtcblxuICAgICAgICAgICAgaWYgKHR5cGVvZiBjYXR3YWxrLmV2ZW50cy5yZWZyZXNoID09PSAnZnVuY3Rpb24nKSB7XG5cbiAgICAgICAgICAgICAgICAvLyBXZSdyZSBhbGwgZG9uZSFcbiAgICAgICAgICAgICAgICBjYXR3YWxrLmV2ZW50cy5yZWZyZXNoKCk7XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBtZXRob2QgY2xlYW5Nb2RlbFxuICAgICAgICAgKiBAcGFyYW0gbW9kZWwge09iamVjdH1cbiAgICAgICAgICogQHJldHVybiB7T2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgY2xlYW5Nb2RlbChtb2RlbCkge1xuXG4gICAgICAgICAgICB2YXIgY2xlYW5lZE1vZGVsID0ge307XG5cbiAgICAgICAgICAgIE9iamVjdC5rZXlzKG1vZGVsKS5mb3JFYWNoKHByb3BlcnR5ID0+IHtcblxuICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eSA9PT0gQ0FUV0FMS19NRVRBX1BST1BFUlRZKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gQ2F0d2FsayBtZXRhIGRhdGEgc2hvdWxkIG5ldmVyIGJlIHBlcnNpc3RlZC5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY2xlYW5lZE1vZGVsW3Byb3BlcnR5XSA9IG1vZGVsW3Byb3BlcnR5XTtcblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJldHVybiBjbGVhbmVkTW9kZWw7XG5cbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGNsYXNzIEJsdWVwcmludE1vZGVsXG4gICAgICovXG4gICAgY2xhc3MgQmx1ZXByaW50TW9kZWwge1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAY29uc3RydWN0b3JcbiAgICAgICAgICogQHJldHVybiB7Qmx1ZXByaW50TW9kZWx9XG4gICAgICAgICAqL1xuICAgICAgICBjb25zdHJ1Y3RvcihibHVlcHJpbnQpIHtcbiAgICAgICAgICAgIHRoaXMubW9kZWwgPSBPYmplY3QuZnJlZXplKGJsdWVwcmludCk7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQ29udmVuaWVuY2UgbWV0aG9kIHRoYXQgd3JhcHMgYGl0ZXJhdGVQcm9wZXJ0aWVzYCBhbmQgYGl0ZXJhdGVCbHVlcHJpbnRgIGludG8gYSBvbmUtbGluZXIuXG4gICAgICAgICAqXG4gICAgICAgICAqIEBtZXRob2QgaXRlcmF0ZUFsbFxuICAgICAgICAgKiBAcGFyYW0gcHJvcGVydGllcyB7T2JqZWN0fVxuICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICBpdGVyYXRlQWxsKHByb3BlcnRpZXMpIHtcbiAgICAgICAgICAgIHZhciBtb2RlbCA9IHRoaXMuaXRlcmF0ZVByb3BlcnRpZXMocHJvcGVydGllcyk7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pdGVyYXRlQmx1ZXByaW50KG1vZGVsKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSZXNwb25zaWJsZSBmb3IgaXRlcmF0aW5nIG92ZXIgdGhlIHBhc3NlZCBpbiBtb2RlbCBwcm9wZXJ0aWVzIHRvIGVuc3VyZSB0aGV5J3JlIGluIHRoZSBibHVlcHJpbnQsXG4gICAgICAgICAqIGFuZCB0eXBlY2FzdGluZyB0aGUgcHJvcGVydGllcyBiYXNlZCBvbiB0aGUgZGVmaW5lIGJsdWVwcmludCBmb3IgdGhlIGN1cnJlbnQgY29sbGVjdGlvbi5cbiAgICAgICAgICpcbiAgICAgICAgICogQG1ldGhvZCBpdGVyYXRlUHJvcGVydGllc1xuICAgICAgICAgKiBAcGFyYW0gcHJvcGVydGllcyB7T2JqZWN0fVxuICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICBpdGVyYXRlUHJvcGVydGllcyhwcm9wZXJ0aWVzKSB7XG5cbiAgICAgICAgICAgIHZhciBtb2RlbCA9IHt9O1xuXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKS5mb3JFYWNoKHByb3BlcnR5ID0+IHtcblxuICAgICAgICAgICAgICAgIHZhciB2YWx1ZSAgICAgICAgICAgPSBwcm9wZXJ0aWVzW3Byb3BlcnR5XSxcbiAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlIYW5kbGVyID0gdGhpcy5tb2RlbFtwcm9wZXJ0eV07XG5cbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb3BlcnR5SGFuZGxlciA9PT0gJ3VuZGVmaW5lZCcpIHtcblxuICAgICAgICAgICAgICAgICAgICAvLyBQcm9wZXJ0eSBkb2Vzbid0IGJlbG9uZyBpbiB0aGUgbW9kZWwgYmVjYXVzZSBpdCdzIG5vdCBpbiB0aGUgYmx1ZXByaW50LlxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb3BlcnR5SGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykge1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIFR5cGVjYXN0IHByb3BlcnR5IHRvIHRoZSBkZWZpbmVkIHR5cGUuXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gcHJvcGVydHlIYW5kbGVyKHZhbHVlKTtcblxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIG1vZGVsW3Byb3BlcnR5XSA9IHZhbHVlO1xuXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcmV0dXJuIG1vZGVsO1xuXG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogUmVzcG9uc2libGUgZm9yIGl0ZXJhdGluZyBvdmVyIHRoZSBibHVlcHJpbnQgdG8gZGV0ZXJtaW5lIGlmIGFueSBwcm9wZXJ0aWVzIGFyZSBtaXNzaW5nXG4gICAgICAgICAqIGZyb20gdGhlIGN1cnJlbnQgbW9kZWwsIHRoYXQgaGF2ZSBiZWVuIGRlZmluZWQgaW4gdGhlIGJsdWVwcmludCBhbmQgdGhlcmVmb3JlIHNob3VsZCBiZVxuICAgICAgICAgKiBwcmVzZW50LlxuICAgICAgICAgKlxuICAgICAgICAgKiBAbWV0aG9kIGl0ZXJhdGVCbHVlcHJpbnRcbiAgICAgICAgICogQHBhcmFtIG1vZGVsIHtPYmplY3R9XG4gICAgICAgICAqIEByZXR1cm4ge09iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIGl0ZXJhdGVCbHVlcHJpbnQobW9kZWwpIHtcblxuICAgICAgICAgICAgT2JqZWN0LmtleXModGhpcy5tb2RlbCkuZm9yRWFjaChwcm9wZXJ0eSA9PiB7XG5cbiAgICAgICAgICAgICAgICAvLyBEZXRlcm1pbmUgaWYgdGhlIHByb3BlcnR5IGhhcyBhIHByb3BlcnR5IGhhbmRsZXIgbWV0aG9kIHdoaWNoIHdvdWxkIGJlIHJlc3BvbnNpYmxlXG4gICAgICAgICAgICAgICAgLy8gZm9yIHR5cGVjYXN0aW5nLCBhbmQgZGV0ZXJtaW5pbmcgdGhlIGRlZmF1bHQgdmFsdWUuXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtb2RlbFtwcm9wZXJ0eV0gPT09ICdmdW5jdGlvbicpIHtcblxuICAgICAgICAgICAgICAgICAgICBsZXQgcHJvcGVydHlIYW5kbGVyID0gdGhpcy5tb2RlbFtwcm9wZXJ0eV07XG4gICAgICAgICAgICAgICAgICAgIG1vZGVsW3Byb3BlcnR5XSAgICAgPSBwcm9wZXJ0eUhhbmRsZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtb2RlbFtwcm9wZXJ0eV0gPT09ICd1bmRlZmluZWQnKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlIHRoYXQgaXQgaXMgZGVmaW5lZC5cbiAgICAgICAgICAgICAgICAgICAgbW9kZWxbcHJvcGVydHldID0gbnVsbDtcblxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJldHVybiBtb2RlbDtcblxuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAY2xhc3MgUmVsYXRpb25zaGlwXG4gICAgICovXG4gICAgY2xhc3MgUmVsYXRpb25zaGlwIHtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQG1ldGhvZCBoYXNPbmVcbiAgICAgICAgICogQHBhcmFtIGZvcmVpZ25LZXkge1N0cmluZ31cbiAgICAgICAgICogQHBhcmFtIGNvbGxlY3Rpb25OYW1lIHtTdHJpbmd9XG4gICAgICAgICAqIEByZXR1cm4ge1JlbGF0aW9uc2hpcEhhc09uZX1cbiAgICAgICAgICovXG4gICAgICAgIGhhc09uZShmb3JlaWduS2V5LCBjb2xsZWN0aW9uTmFtZSkge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBSZWxhdGlvbnNoaXBIYXNPbmUoZm9yZWlnbktleSwgY29sbGVjdGlvbk5hbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBtZXRob2QgaGFzTWFueVxuICAgICAgICAgKiBAcGFyYW0gZm9yZWlnbktleSB7U3RyaW5nfVxuICAgICAgICAgKiBAcGFyYW0gY29sbGVjdGlvbk5hbWUge1N0cmluZ31cbiAgICAgICAgICogQHJldHVybiB7UmVsYXRpb25zaGlwSGFzTWFueX1cbiAgICAgICAgICovXG4gICAgICAgIGhhc01hbnkoZm9yZWlnbktleSwgY29sbGVjdGlvbk5hbWUpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUmVsYXRpb25zaGlwSGFzTWFueShmb3JlaWduS2V5LCBjb2xsZWN0aW9uTmFtZSk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBjbGFzcyBSZWxhdGlvbnNoaXBBYnN0cmFjdFxuICAgICAqL1xuICAgIGNsYXNzIFJlbGF0aW9uc2hpcEFic3RyYWN0IHtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQGNvbnN0cnVjdG9yXG4gICAgICAgICAqIEBwYXJhbSBmb3JlaWduS2V5IHtTdHJpbmd9XG4gICAgICAgICAqIEBwYXJhbSBjb2xsZWN0aW9uTmFtZSB7U3RyaW5nfVxuICAgICAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAgICAgKi9cbiAgICAgICAgY29uc3RydWN0b3IoZm9yZWlnbktleSwgY29sbGVjdGlvbk5hbWUpIHtcbiAgICAgICAgICAgIHRoaXMuZm9yZWlnbktleSAgICAgPSBmb3JlaWduS2V5O1xuICAgICAgICAgICAgdGhpcy5jb2xsZWN0aW9uTmFtZSA9IGNvbGxlY3Rpb25OYW1lO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAY2xhc3MgUmVsYXRpb25zaGlwSGFzTWFueVxuICAgICAqL1xuICAgIGNsYXNzIFJlbGF0aW9uc2hpcEhhc01hbnkgZXh0ZW5kcyBSZWxhdGlvbnNoaXBBYnN0cmFjdCB7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAY2xhc3MgUmVsYXRpb25zaGlwSGFzT25lXG4gICAgICovXG4gICAgY2xhc3MgUmVsYXRpb25zaGlwSGFzT25lIGV4dGVuZHMgUmVsYXRpb25zaGlwQWJzdHJhY3Qge1xuXG4gICAgfVxuXG4gICAgLy8gSW5zdGFudGlhdGUgdGhlIENhdHdhbGsgY2xhc3MuXG4gICAgJHdpbmRvdy5jYXR3YWxrID0gbmV3IENhdHdhbGsoKTtcblxufSkod2luZG93KTsiLCJ2YXIgJF9fcGxhY2Vob2xkZXJfXzAgPSAkX19wbGFjZWhvbGRlcl9fMSIsIigkdHJhY2V1clJ1bnRpbWUuY3JlYXRlQ2xhc3MpKCRfX3BsYWNlaG9sZGVyX18wLCAkX19wbGFjZWhvbGRlcl9fMSwgJF9fcGxhY2Vob2xkZXJfXzIpIiwiJHRyYWNldXJSdW50aW1lLmRlZmF1bHRTdXBlckNhbGwodGhpcyxcbiAgICAgICAgICAgICAgICAkX19wbGFjZWhvbGRlcl9fMC5wcm90b3R5cGUsIGFyZ3VtZW50cykiLCJ2YXIgJF9fcGxhY2Vob2xkZXJfXzAgPSAkX19wbGFjZWhvbGRlcl9fMSIsIigkdHJhY2V1clJ1bnRpbWUuY3JlYXRlQ2xhc3MpKCRfX3BsYWNlaG9sZGVyX18wLCAkX19wbGFjZWhvbGRlcl9fMSwgJF9fcGxhY2Vob2xkZXJfXzIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkX19wbGFjZWhvbGRlcl9fMykiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=