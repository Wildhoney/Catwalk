"use strict";!function(t,e){var n="__catwalk",i={NEW:1,DIRTY:2,SAVED:4,DELETED:8},r=function(){this.events={},this.collections={},this.relationship=new u,this.typecast=new s,this.revertTypecast=!0};$traceurRuntime.createClass(r,{createCollection:function(t){var e=void 0!==arguments[1]?arguments[1]:{};t=String(t),0===t.length&&this.throwException("Collection must have an associated name"),0===Object.keys(e).length&&this.throwException('Collection "'+t+'" must define its blueprint');var n=new o(t,e);return this.collections[t]=n,n},deleteCollection:function(t){this.collections[t]&&delete this.collections[t]},collection:function(t){return"undefined"==typeof this.collections[t]&&this.throwException('Unable to find collection "'+t+'"'),this.collections[t]},createTransaction:function(){return new p},revertCallbackTypecast:function(t){this.revertTypecast=!!t},throwException:function(t){throw"Catwalk: "+t+"."},on:function(t){var e=void 0!==arguments[1]?arguments[1]:function(){},n=this;(t||"").split(/\s+/g).forEach(function(t){n.events[t]=e})},off:function(t){var e=this;(t||"").split(/\s+/g).forEach(function(t){delete e.events[t]})}},{});var o=function(t,e){this.id=0,this.name=t,this.models=[],this.silent=!1,this.blueprint=new a(t,e)};$traceurRuntime.createClass(o,{silently:function(t){var e=this.silent;this.silent=!0,t.apply(this),e||(this.silent=!1)},extensibleIteration:function(){var t=[],e=function(t){var e={};return Object.keys(t).forEach(function(n){return e[n]=t[n]}),e};return this.models.forEach(function(n){return t.push(e(n))}),t},addModel:function(){var t=void 0!==arguments[0]?arguments[0]:{},e=this,n={};return this.silently(function(){n=e.createModel(t)}),this.silent||this.conditionallyEmitEvent(),n},addModels:function(){var t=void 0!==arguments[0]?arguments[0]:[];Array.isArray(t)||catwalk.throwException("Argument for `addModels` must be an array of properties");var e=[];return this.silently(function(){var n=this;t.forEach(function(t){e.push(n.addModel(t))})}),this.conditionallyEmitEvent(),e},createModel:function(){var t=void 0!==arguments[0]?arguments[0]:{};this.injectMeta(t);var e=this.blueprint.iterateAll(t);return Object.seal(e),this.models.push(e),this.issuePromise("create",e,null),e},readModel:function(t){return this.issuePromise("read",t,null),t},updateModel:function(t,e){var n=this,i={};Object.keys(t).forEach(function(e){return i[e]=t[e]});try{Object.keys(e).forEach(function(n){return t[n]=e[n]})}catch(r){}var o=this.blueprint.reiterateProperties(t);return Object.keys(o).forEach(function(e){n.blueprint.model[e]instanceof l||(t[e]=o[e])}),this.issuePromise("update",t,i),t},getModelById:function(t){return this.models.find(function(e){return e[n].id===t})},deleteModel:function(t){var e=this,i=function(t,n){e.issuePromise("delete",null,t),e.models.splice(n,1)},r=!1;return function(){var n=e.models.indexOf(t);-1!==n&&(r=!0,i(e.models[n],n))}(),r||!function(){var r=0;e.models.forEach(function(e){e[n].id===t[n].id&&i(e,r),r++})}(),t},addAssociation:function(t,e,i){this.blueprint.model[e]instanceof c||catwalk.throwException("Using `addAssociation` requires a hasMany relationship");var r=t[n].relationshipValues[e]();r=r.concat(i);var o={};return o[e]=r,this.updateModel(t,o)},removeAssociation:function(t,e,i){this.blueprint.model[e]instanceof c||catwalk.throwException("Using `removeAssociation` requires a hasMany relationship");var r=t[n].relationshipValues[e]();i.forEach(function(t){var e=r.indexOf(t);r.splice(e,1)});var o={};return o[e]=r,this.updateModel(t,o)},injectMeta:function(t){t[n]={id:++this.id,status:i.NEW,originalValues:{},relationshipValues:{}}},issuePromise:function(t,e,n){var i=this;this.silent||"function"==typeof catwalk.events[t]&&new Promise(function(r,o){catwalk.events[t].call(i,i.cleanModel(e||n),{resolve:r,reject:o})}).then(function(r){i.resolvePromise(t,e,n)(r)},function(r){i.rejectPromise(t,e,n)(r)})},resolvePromise:function(t,e,r){var o=this;return e&&"create"===t&&(e[n].status=i.SAVED),null===e&&r&&"delete"===t&&(r[n].status=i.DELETED),function(i){o.silently(function(){if(i&&"read"!==t&&o.updateModel(e,i),i&&!i.hasOwnProperty(n)&&"read"===t){var r=o.createModel(i);o.updateModel(e,r)}}),o.conditionallyEmitEvent()}},rejectPromise:function(t,e,r){var o=this,a=function(a){a&&o.silently(function(){"update"===t&&a.hasOwnProperty(n)&&(o.deleteModel(r),r[n].status=i.DELETED),o.updateModel(e,a),e[n].status=i.SAVED}),o.conditionallyEmitEvent()};return null===r&&"create"===t?(this.silently(function(){o.deleteModel(e),e[n].status=i.DELETED}),a):(null===e&&"delete"===t&&this.silently(function(){var t=o.updateModel({},r);o.models.push(t)}),e&&r&&"update"===t&&this.silently(function(){o.updateModel(e,r)}),a)},conditionallyEmitEvent:function(){"function"==typeof catwalk.events.refresh&&(catwalk.events.refresh(),this.awakenFramework().angular())},awakenFramework:function(){return{angular:function(){if("undefined"!=typeof t.angular){var n=t.angular.element(e.querySelector("*[ng-app]"));if("scope"in n){var i=n.scope();i.$$phase||i.$apply()}}}}},cleanModel:function(t){var e=this,i={};return Object.keys(t).forEach(function(r){if(r!==n){if(e.blueprint.model[r]instanceof l){var o=t[n].relationshipValues[r];return void(o&&(i[r]=o()))}return"function"==typeof e.blueprint.model[r]&&t[n]&&t[n].originalValues[r]?void(i[r]=t[n].originalValues[r]):void(i[r]=t[r])}}),i}},{});var a=function(t,e){this.name=t,this.model=Object.freeze(e)};$traceurRuntime.createClass(a,{iterateAll:function(t){var e=this.iterateProperties(t);return this.iterateBlueprint(e)},iterateProperties:function(t){var e=this,i={};return Object.keys(t).forEach(function(r){var o=t[r],a=e.model[r];if(r===n||"undefined"!=typeof a){if(a instanceof l&&(a=e.relationshipHandler(a),Object.defineProperty(i,r,a.defineRelationship(e.name,r)),a.setValues(t[r]),t[n]&&(t[n].relationshipValues[r]=function(){return a.values})),"function"==typeof a){var s=o;o=a(o),catwalk.revertTypecast&&s!==o&&(t[n].originalValues[r]=s)}i[r]=o}}),i},iterateBlueprint:function(t){var e=this;return Object.keys(this.model).forEach(function(n){if("undefined"==typeof t[n]){t[n]=e.model[n];var i=e.model[n];if(i instanceof l)return i=e.relationshipHandler(i),Object.defineProperty(t,n,i.defineRelationship(e.name,n)),void i.setValues([]);"function"==typeof e.model[n]&&(t[n]=i())}}),t},reiterateProperties:function(t){var e=this;return Object.keys(t).forEach(function(n){var i=e.model[n];"function"==typeof i&&(t[n]=i(t[n]))}),t},relationshipHandler:function(t){var e=[t.target.key,t.target.collection];return t instanceof c?new(Function.prototype.bind.apply(c,$traceurRuntime.spread([null],e))):t instanceof d?new(Function.prototype.bind.apply(d,$traceurRuntime.spread([null],e))):void catwalk.throwException("Invalid relationship type")}},{});var s=function(){};$traceurRuntime.createClass(s,{returnValue:function(t,e,n){return t("undefined"!=typeof e?e:n)},string:function(){var t=void 0!==arguments[0]?arguments[0]:"",e=this;return function(n){return e.returnValue(String,n,t)}},"boolean":function(){var t=void 0!==arguments[0]?arguments[0]:!0,e=this;return function(n){return e.returnValue(Boolean,n,t)}},number:function(){var t=void 0!==arguments[0]?arguments[0]:0,e=this;return function(n){return e.returnValue(Number,n,t)}},array:function(){var t=void 0!==arguments[0]?arguments[0]:[],e=this;return function(n){return e.returnValue(Array,n,t)}},autoIncrement:function(){var t=void 0!==arguments[0]?arguments[0]:1;return function(){return Number(t++)}},custom:function(t){return t}},{});var u=function(){};$traceurRuntime.createClass(u,{hasOne:function(t,e){return new d(t,e)},hasMany:function(t,e){return new c(t,e)}},{});var l=function(t,e){this.target={collection:e,key:t}};$traceurRuntime.createClass(l,{setValues:function(t){this.values=this.value=t},defineRelationship:function(t,e,n){return this.source={collection:t,key:e},{get:n.get,set:n.set,enumerable:!0}},assertForeignPropertyExists:function(t,e){"undefined"==typeof t.blueprint.model[e]&&catwalk.throwException('Unable to find property "'+e+'" in collection "'+t.name+'"')}},{});var c=function(){$traceurRuntime.defaultSuperCall(this,f.prototype,arguments)},f=c;$traceurRuntime.createClass(c,{defineRelationship:function(t,e){return $traceurRuntime.superCall(this,f.prototype,"defineRelationship",[t,e,{get:this.getModels.bind(this),set:this.setModels.bind(this)}])},getModels:function(){var t=this,e=function(){return i.models.filter(function(e){return-1!==t.values.indexOf(e[t.target.key])})},n=function(t,e){return t.filter(function(t){return e.indexOf(t)<0})},i=catwalk.collection(this.target.collection),r=e();if(this.assertForeignPropertyExists(i,this.target.key),r.length!==this.values.length){var o=r.map(function(e){return e[t.target.key]}),a=n(this.values,o);a.forEach(function(e){var n={};n[t.target.key]=e,i.readModel(n)}),r=e()}return r},setModels:function(t){this.values=t}},{},l);var d=function(){$traceurRuntime.defaultSuperCall(this,h.prototype,arguments)},h=d;$traceurRuntime.createClass(d,{defineRelationship:function(t,e){return $traceurRuntime.superCall(this,h.prototype,"defineRelationship",[t,e,{get:this.getModel.bind(this),set:this.setModel.bind(this)}])},getModel:function(){var t=this,e=function(){return n.models.find(function(e){return t.value===e[t.target.key]})},n=catwalk.collection(this.target.collection),i=e();if(this.assertForeignPropertyExists(n,this.target.key),!i){var r={};r[this.target.key]=this.value,n.readModel(r),i=e()}return i},setModel:function(t){this.value=t}},{},l);var p=function(){var t=this;this.models=[],this.resolveFn=function(){},setTimeout(function(){return t.flush})};$traceurRuntime.createClass(p,{add:function(t,e){this.models.push({model:t,promise:e})},resolve:function(t){this.resolveFn=t},flush:function(){this.resolveFn(this.models)}},{}),t.catwalk=new r,t.catwalk.META=n,t.catwalk.STATES=i}(window,window.document);