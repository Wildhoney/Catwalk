/*! catwalk.js by Adam Timberlake created on 2013-12-28 */
!function(a){"use strict";if("undefined"==typeof a.Q)throw"Catwalk requires Q: https://github.com/kriskowal/q";if("undefined"==typeof a._)throw"Catwalk requires Underscore: http://underscorejs.org/";if("undefined"==typeof a.crossfilter)throw"Catwalk requires Crossfilter: https://github.com/square/crossfilter";a.catwalk={}}(window),function(a){"use strict";if("undefined"!=typeof a.catwalk){var b=function(a){return String(a)},c=function(a){return Number(a)},d=function(a){return function(b){return Number(b).toFixed(a)}},e=function(b){if("undefined"==typeof a.moment)throw"Typecasting to date format requires Moment.js: http://momentjs.com/";return function(c){return a.moment(c).format(b)}},f=function(a){return Boolean(a)},g=function(a){return a};a.catwalk.attribute={string:b,number:c,integer:c,date:e,"float":d,"boolean":f,custom:g}}}(window),function(a,b,c){"use strict";if("undefined"!=typeof a){var d={},e=null,f=function(){return this};a.updated=function(a){f=a};var g=function(a,b){if("undefined"==typeof b._primaryKey)throw"You must define the `_primaryKey` property for your collection.";if(!_.contains(_.keys(b),b._primaryKey))throw"Your `_primaryKey` must map to one of your collection properties.";this._crossfilter={},this._dimensions={},this._properties={},this._deletedIds=[],this._resolvedIds=[],this._name=a,this._properties=b,this._properties._computed=null;var d=this._crossfilter=c([]),e=this._dimensions,f=_.keys(b);_.forEach(f,_.bind(function(a){"_"!==a.charAt(0)&&"$"!==a.charAt(0)&&(e[a]=d.dimension(function(b){return b[a]}),0===b[a].length&&(this._properties._computed||(this._properties._computed={}),this._properties._computed[a]=b[a]))},this)),e.catwalkId=d.dimension(function(a){return a._catwalkId})};g.prototype={_name:"",_resolvedIds:[],_properties:{},_crossfilter:{},_dimensions:{},_deletedIds:[],all:function(){return this._dimensions[this._properties._primaryKey].filterAll().top(1/0)},size:function(){return this._crossfilter.size()},addModel:function(a){return this.createModel(a,!1)},createModel:function(b,c){var d=this._properties,e=_.bind(this._createRelationship,this),f=this._properties._relationships||{},g=this._dimensions.catwalkId,h=this._properties._computed,i=parseInt(_.uniqueId(),10);return null===b[this._properties._primaryKey]&&(b.id=parseInt(i)),delete b._propertyMeta,b._catwalkId=i,b._collection=this._name,b._propertyMeta=_.clone(b),this._fillDefaults(b),_.forEach(b,function(c,g){if("_"!==g.charAt(0)&&"$"!==g.charAt(0)){if(h&&_.contains(_.keys(h),g))throw'You are attempting to provide a value for the "'+g+'" computed property.';if("object"!=typeof f[g]){if("function"==typeof f[g])return e(b,g,c),void 0;if(!_.contains(_.keys(d),g)&&!_.contains(_.keys(f),g),"function"==typeof d[g])return b[g]=d[g](c),void 0;var i=typeof d[g],j=_.contains(["string","number","boolean"],i);j&&(b[g]=a.attribute[i](c))}}}),h&&_.forEach(h,function(a,c){b[c]=a.apply(b)}),this._crossfilter.add([b]),this._finalise("create",g.top(1/0)[0],{},c)},_createResolve:function(a,b,c){var d=!!(c&&"_catwalkId"in c&&c._catwalkId!==a._catwalkId);d&&(this.deleteModel(a),a.id=c.id),_.forEach(this._properties._relationships,function(b,c){"object"==typeof b&&a[c]&&b.createAssociation(a,c)}),d||(a=_.extend(a,c))},_createReject:function(a){this.deleteModel(a,!1)},updateModel:function(a,b,c){this._assertValid(a),this.deleteModel(a,!1);var d=_.extend(_.clone(a._propertyMeta),b);return _.forEach(this._properties._relationships,function(c,e){delete d[e],d[e]=b[e]?b[e]:a._relationshipMeta[e]}),_.forEach(d._relationshipMeta,function(a,b){d[b]=a}),delete d._relationshipMeta,this._finalise("update",this.createModel(d,!1),a,c)},_updateReject:function(a,b){this.deleteModel(a,!1),this._reanimateModel(b)},deleteModel:function(a,b){if(this._assertValid(a),!("_catwalkId"in a))throw"You are attempting to remove a non-Catwalk model.";return this._deletedIds.push(a._catwalkId),this._dimensions.catwalkId.filterFunction(_.bind(function(a){return!_.contains(this._deletedIds,a)},this)),this._finalise("delete",a,{},b)},_deleteReject:function(a){this._reanimateModel(a)},_reanimateModel:function(a){var b=a._catwalkId,c=_.indexOf(this._deletedIds,b);this._deletedIds.splice(c,1),this._dimensions.catwalkId.filterFunction(_.bind(function(a){return!_.contains(this._deletedIds,a)},this))},_createRelationship:function(a,b,c){var d=this._properties._relationships||{};Object.defineProperty(a,b,{get:function(){return d[b](c)},configurable:!0}),"_relationshipMeta"in a||(a._relationshipMeta={}),a._relationshipMeta[b]=c},_assertValid:function(a){if(!("_catwalkId"in a))throw"You are attempting to manipulate a non-Catwalk model.";if(_.contains(this._deletedIds,a._catwalkId))throw"You are trying to modify a model in the garbage collection.";if(a._collection!==this._name)throw'Model belongs to "'+a._collection+'" collection, not "'+this._name+'".';return!0},_fillDefaults:function(a){_.forEach(this._properties,_.bind(function(b,c){if("_"!==c.charAt(0)){var d=_.contains(["number","string","boolean","object"],typeof b),e="undefined"==typeof a[c];e&&d&&(a[c]=b)}},this))},_finalise:function(c,g,h,i){i=!("undefined"!=typeof i&&!i);var j=b.defer(),k=_.bind(function(){e&&clearTimeout(e),e=setTimeout(function(){f(d)},1)},this),l=_.bind(function(a){if("undefined"==typeof a)return{};a=_.clone(a),_.forEach(a._relationshipMeta,function(b,c){a[c]=b}),delete a._collection,delete a._catwalkId,delete a._relationshipMeta;var b=_.keys(this._properties);return _.forEach(a,function(c,d){_.contains(b,d)||delete a[d]}),delete a._propertyMeta,a},this),m=_.bind(function(a,b){var d="_"+c+a,e=this[d];"function"==typeof e&&e.apply(this,[g,h,b])},this);return i&&(a.event.broadcastOthers(c,this,j,l(g)),j.promise.then(_.bind(function(a){m("Resolve",a),k()},this)),j.promise.fail(_.bind(function(){m("Reject"),k()},this))),k(),g}},a.deleteCollection=function(a){delete d[a]},a.collection=function(a,b){if(b){if("undefined"!=typeof d[a])throw'You are attempting to overwrite an existing "'+a+'" collection.';return d[a]=new g(a,b),d[a]}if("undefined"==typeof d[a])throw'Catwalk is unable to find a collection named "'+a+'".';return d[a]}}}(window.catwalk,window.Q,window.crossfilter),function(a){"use strict";"undefined"!=typeof a.catwalk&&(a.catwalk.computedProperty=function(a){return a})}(window),function(a){"use strict";var b=function(a,b){b.resolve()};a.event={_events:{create:b,read:b,update:b,"delete":b},on:function(a,b){this._events[a]=b},broadcastRead:function(b,c,d,e,f){var g=b+"/"+c._name;this._getCallback(g,b).call(a,c._name,d,e,f)},broadcastOthers:function(b,c,d,e){var f=b+"/"+c._name;this._getCallback(f,b).call(a,c._name,d,e)},_getCallback:function(a,b){return _.contains(_.keys(this._events),a)?this._events[a]:this._events[b]}}}(window.catwalk),function(a,b,c){"use strict";if("undefined"!=typeof b){var d=function(a){return _.bind(function(d){d=this._typecast(a,d);var e=this._getCollection(a),f=this._getModels(d,a)[0];if(!f&&-1===_.indexOf(e._resolvedIds,d)){var g=c.defer();b.event.broadcastRead("read",e,g,a.foreignKey,d),e._resolvedIds.push(d),g.promise.then(function(a){e.addModel(a)})}return f},this)},e=function(a){return _.bind(function(d){d=this._typecast(a,d);var e=this._getCollection(a),f=this._getModels(d,a);if(d.length!==f.length){var g=_.difference(d,_.pluck(f,"id"));_.forEach(g,function(d){var f=c.defer();-1===_.indexOf(e._resolvedIds,d)&&(b.event.broadcastRead("read",e,f,a.foreignKey,d),e._resolvedIds.push(d),f.promise.then(function(a){e.addModel(a)}))})}return f},this)},f=function(a){return{createAssociation:function(c,d){var e=function(b){return b===c[a.collection]},f=b.collection(a.collection),g=f._dimensions[d],h=g.filterFunction(e).top(1/0)[0],i=h._relationshipMeta[a.foreignKey];i.push(c[d])}}};a.catwalk.relationship={hasOne:d,hasMany:e,belongsTo:f,hasAndBelongsToMany:function(){},_getCollection:function(a){return b.collection(a.collection)},_getModels:function(a,b){var c=this._getCollection(b)._dimensions[b.foreignKey],d=function(){};if("undefined"==typeof c)throw'Attempting to map to an invalid "'+b.foreignKey+'" property on the "'+b.collection+'" collection.';d=_.isArray(a)?function(b){return _.contains(a,b)}:function(b){return b===a};var e=c.filterFunction(d).top(1/0);return c.filterAll(),e},_typecast:function(a,b){return a.typecast?_.isArray(b)?_.map(b,function(b){return a.typecast(b)}):a.typecast(b):b}}}}(window,window.catwalk,window.Q);