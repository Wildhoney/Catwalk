/*! catwalk.js by Adam Timberlake created on 2013-12-16 */
!function(a){"use strict";a.catwalk={}}("undefined"!=typeof window?window:module),function(a){"use strict";var b=function(a){return String(a)},c=function(a){return Number(a)},d=function(a){return Number(a)},e=function(a){return Boolean(a)};a.catwalk.attribute={string:b,integer:c,"float":d,"boolean":e}}(window),function(a,b){"use strict";var c={},d=function(a,b){var c=function(){};this._crossfilter={},this._dimensions={},this._deletedIds=[],this._resolvedIds=[],this._events={create:c,read:c,update:c,"delete":c,content:c},this._name=a,this._properties=b;var d=this._crossfilter=crossfilter([]),e=this._dimensions,f=_.keys(b);_.forEach(f,function(a){"_"!==a.charAt(0)&&"$"!==a.charAt(0)&&(e[a]=d.dimension(function(b){return b[a]}))}),e.catwalkId=d.dimension(function(a){return a._catwalkId})};d.prototype={_name:"",_events:{},_resolvedIds:[],_properties:{},_crossfilter:{},_dimensions:{},_deletedIds:[],watch:function(a,b){this._events[a]=b},all:function(){return this._dimensions[this._properties._primaryKey].filterAll().top(1/0)},size:function(){return this._crossfilter.size()},createModel:function(a,b){var c=this._properties,d=_.bind(this._createRelationship,this),e=this._properties._relationships||{},f=this._dimensions.catwalkId;return a._catwalkId=_.uniqueId(),a._collection=this._name,_.forEach(a,function(b,f){if("_"!==f.charAt(0)&&"$"!==f.charAt(0)){if("function"==typeof e[f])return d(a,f,b),void 0;try{a[f]=c[f](b)}catch(g){throw"You forgot to define the `"+f+"` property on the collection blueprint."}}}),this._crossfilter.add([a]),this._finalise("create",f.top(1/0)[0],{},b)},_createResolve:function(a,b,c){for(var d in c)if(c.hasOwnProperty(d)){if("undefined"==typeof a._relationshipMeta[d])continue;throw'You are attempting to manipulate the "'+d+'" relationship during model creation.'}a=_.extend(a,c)},_createReject:function(a){this.deleteModel(a,!1)},updateModel:function(a,b,c){this._assertValid(a),this.deleteModel(a,!1);var d=_.extend(_.clone(a),b);return _.forEach(this._properties._relationships,function(c,e){delete d[e],d[e]=b[e]?b[e]:a._relationshipMeta[e]}),delete d._relationshipMeta,this._finalise("update",this.createModel(d),a,c)},_updateReject:function(a,b){this.deleteModel(a,!1),this._reanimateModel(b)},deleteModel:function(a,b){this._assertValid(a);var c=this._deletedIds;if(!("_catwalkId"in a))throw"You are attempting to remove a non-Catwalk model.";return c.push(a._catwalkId),this._dimensions.catwalkId.filterFunction(function(a){return!_.contains(c,a)}),this._finalise("delete",a,{},b)},_deleteReject:function(a){this._reanimateModel(a)},_reanimateModel:function(a){var b=a._catwalkId,c=_.indexOf(this._deletedIds,b);this._deletedIds.splice(c,1),this._dimensions.catwalkId.filterFunction(_.bind(function(a){return!_.contains(this._deletedIds,a)},this))},_createRelationship:function(a,b,c){var d=this._properties._relationships||{};Object.defineProperty(a,b,{get:function(){return d[b](c)}}),"_relationshipMeta"in a||(a._relationshipMeta={}),a._relationshipMeta[b]=c},_assertValid:function(a){if(!("_catwalkId"in a))throw"You are attempting to manipulate a non-Catwalk model.";if(a._collection!==this._name)throw'Model belongs to "'+a._collection+'" collection, not "'+this._name+'".';return!0},_finalise:function(a,c,d,e){e=!("undefined"!=typeof e&&!e);var f=b.defer(),g=_.bind(function(){this._events.content(this.all())},this),h=function(a){return"undefined"==typeof a?{}:(a=_.clone(a),_.forEach(a._relationshipMeta,function(b,c){a[c]=b}),delete a._collection,delete a._catwalkId,delete a._relationshipMeta,a)},i=_.bind(function(b,e){var f="_"+a+b,g=this[f];"function"==typeof g&&g.apply(this,[c,d,e])},this);return e&&(this._events[a](f,h(c)),f.promise.then(_.bind(function(a){i("Resolve",a),g()},this)),f.promise.fail(_.bind(function(){i("Reject"),g()},this))),g(),c}},a.deleteCollection=function(a){delete c[a]},a.collection=function(a,b){if(b){if("undefined"!=typeof c[a])throw'You are attempting to overwrite an existing "'+a+'" collection.';return c[a]=new d(a,b),c[a]}if("undefined"==typeof c[a])throw'Catwalk is unable to find a collection named "'+a+'".';return c[a]}}(window.catwalk,window.Q),function(a,b,c){"use strict";var d=function(a){return function(d){var e=b.collection(a.collection),f=e._dimensions[a.foreignKey];if("undefined"==typeof f)throw'Attempting to map to an invalid "'+a.foreignKey+'" property on the "'+a.collection+'" collection.';var g=f.filterFunction(function(a){return d===a}).top(1/0)[0];if(f.filterAll(),!g&&-1===_.indexOf(e._resolvedIds,d)){var h=c.defer();e._events.read(h,a.foreignKey,d),e._resolvedIds.push(d),h.promise.then(function(a){e.createModel(a)})}return g}},e=function(a){return function(d){var e=b.collection(a.collection),f=e._dimensions[a.foreignKey];if("undefined"==typeof f)throw'Attempting to map to an invalid "'+a.foreignKey+'" property on the "'+a.collection+'" collection.';var g=f.filterAll().filterFunction(function(a){return!!_.contains(d,a)}).top(1/0);if(f.filterAll(),d.length!==g.length){var h=c.defer(),i=_.difference(d,_.pluck(g,"id"));_.forEach(i,function(b){-1===_.indexOf(e._resolvedIds,b)&&(e._events.read(h,a.foreignKey,b),e._resolvedIds.push(b))}),h.promise.then(function(a){e.createModel(a)})}return g}};a.catwalk.relationship={hasOne:d,hasMany:e,belongsTo:function(){},hasAndBelongsToMany:function(){}}}(window,window.catwalk,window.Q);